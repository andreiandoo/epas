# Integrare PayU

## Prezentare Scurtă

Extinde-ți reach-ul în Europa Centrală și de Est cu PayU, procesatorul de plăți dominant din regiune. Cu operațiuni în Polonia, Republica Cehă, România, Ungaria și nu numai, PayU te conectează la milioane de clienți folosind metodele lor locale de plată preferate.

PayU înțelege piețele regionale ca nimeni altul. Fiecare țară are preferințe unice de plată - clienții polonezi adoră BLIK, cehii preferă transferurile bancare, românii au încredere în cardurile locale. PayU le gestionează pe toate printr-o singură integrare.

Plățile cu cardul sunt doar începutul. Acceptă Visa, Mastercard și scheme de carduri locale în toate piețele. Dar puterea reală constă în metodele alternative de plată care domină preferințele regionale.

Transferurile bancare se procesează instantaneu în multe piețe. Clienții se autentifică cu banca lor și finalizează plata fără a introduce detaliile cardului. Familiar, de încredere și rapid.

Opțiunile de cumpără acum, plătește mai târziu prin partenerii PayU permit clienților să răspândească plățile în timp. Perfect pentru pachetele premium de bilete și evenimente de mare valoare.

Securitatea acoperă fiecare tranzacție. Autentificarea 3D Secure, detectarea fraudei și conformitatea PCI îți protejează afacerea și clienții în toate metodele de plată.

Un singur dashboard arată totul. Monitorizează tranzacțiile din toate țările și metodele de plată. Raportarea unificată simplifică operațiunile multi-piață.

Decontarea în valute locale reduce complexitatea cursului de schimb. Primește fonduri în PLN, CZK, RON, HUF sau EUR în funcție de prezența ta pe piață.

---

## Descriere Detaliată

Microserviciul de Integrare PayU conectează platforma ta de ticketing pentru evenimente cu rețeaua completă de plăți PayU din Europa Centrală și de Est. Această integrare oferă acces la metode locale de plată, procesare multi-valută și funcționalități specifice regiunii.

### Acoperire Regională

PayU operează în multiple piețe CEE:

- **Polonia**: Carduri, BLIK, transferuri bancare online, rate
- **Republica Cehă**: Carduri, transferuri bancare, Apple Pay, Google Pay
- **România**: Carduri, integrare bancară locală
- **Ungaria**: Carduri, metode locale de plată
- **Slovacia**: Carduri, transferuri bancare

### Metode de Plată per Piață

#### Polonia
BLIK domină plățile mobile. Clienții introduc un cod de 6 cifre din aplicația lor bancară pentru a autoriza plățile instantaneu. Opțiunile de transfer bancar includ băncile poloneze majore cu confirmare în timp real.

#### Republica Cehă
Transferurile bancare online (platba online) sunt extrem de populare. PayU se conectează direct la băncile cehe pentru confirmarea instantanee a plății. Cardurile rămân importante pentru clienții internaționali.

#### România
Plăți locale cu cardul prin băncile românești. Integrarea cu sistemul bancar românesc asigură procesarea fluidă pentru cardurile domestice.

### Experiența de Checkout

PayU oferă două abordări de integrare:

1. **Redirecționare**: Clienții merg la pagina de plată găzduită PayU pentru a selecta metoda și a finaliza plata
2. **Încorporat**: Widget-urile PayU se încorporează direct în checkout-ul tău pentru capturarea fluidă a cardului

Ambele abordări mențin conformitatea PCI oferind în același timp flexibilitate în designul checkout-ului.

### Prevenirea Fraudei

Sistemele de management al riscului PayU analizează tranzacțiile în întreaga lor rețea. Modelele de machine learning identifică tiparele de fraudă minimizând în același timp falsele pozitive. Regulile personalizabile îți permit să ajustezi toleranța la risc pentru afacerea ta.

### Procesare Multi-Valută

Acceptă plăți în valute locale și decontează în valuta preferată. PayU gestionează conversia cu cursuri de schimb competitive. Aceasta simplifică strategia de prețuri - arată PLN clienților polonezi, CZK clienților cehi.

### Plăți Recurente

Stocarea cardurilor bazată pe token-uri permite plăți cu un click pentru clienții care revin. Util pentru deținătorii de abonamente de sezon sau participanții frecvenți la evenimente care doresc checkout fără fricțiuni.

---

## Funcționalități

### Metode de Plată
- Carduri Visa și Mastercard
- Scheme locale de carduri
- BLIK (Polonia)
- Transferuri bancare (multiple țări)
- Apple Pay
- Google Pay
- Plăți în rate
- Opțiuni de plată ulterioară

### Suport Regional
- Polonia (PLN)
- Republica Cehă (CZK)
- România (RON)
- Ungaria (HUF)
- Slovacia (EUR)
- Prețuri multi-valută

### Securitate
- Autentificare 3D Secure 2
- Conformitate PCI DSS Nivel 1
- Detectarea fraudei cu AI
- Reguli de risc personalizabile
- Monitorizarea tranzacțiilor
- Gestionarea chargeback-urilor

### Opțiuni de Checkout
- Pagină de plată găzduită
- Formular de card încorporat
- Widget-uri metode de plată
- Flux optimizat pentru mobil
- Interfețe localizate
- Branding personalizat

### Gestionarea Tranzacțiilor
- Actualizări status în timp real
- Notificări webhook
- Rambursări complete și parțiale
- Logică de reîncercare plată
- Operațiuni de capturare și anulare
- API management comenzi

### Raportare și Analiză
- Dashboard unificat multi-piață
- Căutare și export tranzacții
- Rapoarte de decontare
- Analize performanță
- Urmărirea conversiei valutare
- Generare rapoarte personalizate

---

## Cazuri de Utilizare

### Evenimente Multi-Țară
Vinde bilete la evenimente care atrag audiențe din multiple țări CEE. Fiecare client vede metodele lor locale de plată. Un festival de muzică în Cracovia ajunge la audiențe poloneze, cehe și slovace fără probleme.

### Focus pe Piața Poloneză
Capitalizează pe piața de evenimente în plină expansiune a Poloniei. Integrarea BLIK captează consumatorii mobile-first care preferă plățile bazate pe aplicații în locul cardurilor tradiționale.

### Turneele de Concerte Cehe
Procesează plăți pentru turneele în locațiile cehe. Integrarea transferurilor bancare se potrivește cu modul în care consumatorii cehi preferă să plătească pentru divertisment.

### Circuitul Regional de Festivaluri
Operează festivaluri în multiple țări CEE cu procesare unificată a plăților. O singură integrare gestionează toate piețele respectând preferințele locale.

### Vânzări de Bilete Cross-Border
Evenimentele europene care atrag audiențe internaționale beneficiază de suportul multi-valută PayU. Clienții plătesc în valute familiare indiferent de locația evenimentului.

### Pachete Premium
Oferă plăți în rate pentru experiențe VIP și pachete premium. Opțiunile de plată ulterioară PayU fac biletele scumpe mai accesibile fără a-ți crește riscul.

---

## Documentație Tehnică

### Prezentare Generală

Microserviciul de Integrare PayU gestionează procesarea plăților în rețeaua CEE PayU. Gestionează crearea comenzilor, selectarea metodei de plată, urmărirea statusului și operațiunile de rambursare.

### Cerințe Preliminare

- Cont de comerciant PayU pentru piețele țintă
- Credențiale OAuth (client_id și client_secret)
- URL endpoint webhook
- POS ID pentru fiecare piață/valută

### Configurare

```php
'payu' => [
    'pos_id' => env('PAYU_POS_ID'),
    'client_id' => env('PAYU_CLIENT_ID'),
    'client_secret' => env('PAYU_CLIENT_SECRET'),
    'second_key' => env('PAYU_SECOND_KEY'),
    'sandbox' => env('PAYU_SANDBOX', false),
    'default_currency' => 'PLN',
    'notify_url' => env('APP_URL') . '/api/webhooks/payu',
    'continue_url' => env('APP_URL') . '/checkout/complete',
]
```

### Endpoint-uri API

#### Creare Comandă

```
POST /api/payments/payu/orders
```

Creează o comandă de plată.

**Cerere:**
```json
{
  "amount": 15000,
  "currency": "PLN",
  "description": "Bilete concert - 2 x Acces General",
  "external_order_id": "order_123",
  "customer": {
    "email": "client@exemplu.pl",
    "first_name": "Jan",
    "last_name": "Kowalski",
    "phone": "+48123456789"
  },
  "products": [
    {
      "name": "Acces General",
      "unit_price": 7500,
      "quantity": 2
    }
  ]
}
```

**Răspuns:**
```json
{
  "order_id": "WZHF5FFDRJ140731GUEST000P01",
  "redirect_uri": "https://secure.payu.com/pay/?orderId=...",
  "status": "NEW"
}
```

#### Obținere Status Comandă

```
GET /api/payments/payu/orders/{orderId}
```

#### Anulare Comandă

```
DELETE /api/payments/payu/orders/{orderId}
```

#### Procesare Rambursare

```
POST /api/payments/payu/orders/{orderId}/refunds
```

**Cerere:**
```json
{
  "description": "Clientul a solicitat rambursare",
  "amount": 7500
}
```

#### Listare Metode de Plată

```
GET /api/payments/payu/methods?currency=PLN
```

Returnează metodele de plată disponibile pentru valută.

### Handler Webhook

```
POST /api/webhooks/payu
```

PayU trimite notificări pentru schimbările de status ale comenzii.

**Payload:**
```json
{
  "order": {
    "orderId": "WZHF5FFDRJ140731GUEST000P01",
    "extOrderId": "order_123",
    "orderCreateDate": "2025-01-15T12:00:00.000+01:00",
    "status": "COMPLETED",
    "totalAmount": "15000",
    "currencyCode": "PLN"
  }
}
```

### Statusuri Comandă

| Status | Descriere |
|--------|-----------|
| NEW | Comandă creată |
| PENDING | Se așteaptă plata |
| WAITING_FOR_CONFIRMATION | Plată primită, se așteaptă capturarea |
| COMPLETED | Plată reușită |
| CANCELED | Comandă anulată |
| REJECTED | Plată respinsă |

### Autentificare

PayU folosește OAuth 2.0 pentru autentificarea API.

```php
// Obține token de acces
POST https://secure.payu.com/pl/standard/user/oauth/authorize

// Headere pentru apeluri API
Authorization: Bearer {access_token}
Content-Type: application/json
```

### Verificarea Semnăturii

```php
// Verifică semnătura webhook
$signature = hash('md5', $jsonBody . $secondKey);
if ($signature !== $request->header('OpenPayu-Signature')) {
    throw new InvalidSignatureException();
}
```

### Coduri de Eroare

| Cod | Descriere |
|-----|-----------|
| UNAUTHORIZED | Credențiale invalide |
| DATA_NOT_FOUND | Comandă negăsită |
| BUSINESS_ERROR | Încălcare regulă de business |
| ERROR_VALUE_MISSING | Câmp obligatoriu lipsă |
| ERROR_VALUE_INVALID | Valoare câmp invalidă |

### Testare

Folosește mediul sandbox cu credențiale de test:

```
PAYU_SANDBOX=true
```

Numere de card pentru test:
- `4444333322221111` - Plată reușită
- `5434021016824014` - 3DS necesar

### Flux de Integrare

```php
// 1. Creare comandă
$order = $payu->createOrder([
    'amount' => $cart->total * 100, // suma în cenți
    'currency' => 'PLN',
    'description' => $cart->description,
    'customer' => $customer->toPayU(),
    'products' => $cart->items->map->toPayU(),
]);

// 2. Redirecționare client
return redirect($order['redirect_uri']);

// 3. Gestionare webhook
public function webhook(Request $request)
{
    $this->verifySignature($request);

    $notification = json_decode($request->getContent(), true);
    $order = Order::findByExternalId($notification['order']['extOrderId']);

    if ($notification['order']['status'] === 'COMPLETED') {
        $order->markAsPaid();
    }

    return response('OK');
}
```

### Configurare Multi-Piață

```php
'payu_markets' => [
    'pl' => [
        'pos_id' => env('PAYU_PL_POS_ID'),
        'client_id' => env('PAYU_PL_CLIENT_ID'),
        'client_secret' => env('PAYU_PL_CLIENT_SECRET'),
    ],
    'cz' => [
        'pos_id' => env('PAYU_CZ_POS_ID'),
        'client_id' => env('PAYU_CZ_CLIENT_ID'),
        'client_secret' => env('PAYU_CZ_CLIENT_SECRET'),
    ],
    // Adaugă mai multe piețe după necesitate
]
```

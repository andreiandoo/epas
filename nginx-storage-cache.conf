# =============================================================================
# Nginx Performance: Gzip + Cache Headers + WebP Auto-Serve
# =============================================================================
# Add this to the server block of bilete.online / core.tixello.com.
#
# Location: usually /etc/nginx/sites-available/bilete.online
# or /etc/nginx/conf.d/bilete.online.conf
#
# After adding, test and reload:
#   sudo nginx -t && sudo systemctl reload nginx
#
# Verify gzip: curl -sI -H "Accept-Encoding: gzip" https://bilete.online/ | grep content-encoding
#   Should show: content-encoding: gzip
#
# Verify cache: curl -I https://core.tixello.com/storage/some-image.jpg
#   Should show: Cache-Control: public, max-age=31536000, immutable
#
# Verify WebP: curl -I -H "Accept: image/webp" https://core.tixello.com/storage/some-image.jpg
#   Should show: Content-Type: image/webp (if .webp version exists)
#
# Prerequisites:
#   php artisan storage:convert-webp          (create .webp versions)
#   php artisan storage:convert-webp --dry-run (preview without changes)
# =============================================================================

# --- Gzip Compression ---
# Reduces transfer size by 60-80% for text-based assets.
# Check if already enabled in main nginx.conf â€” if so, these just ensure
# the right MIME types are covered. Duplicate gzip directives are safe.
gzip on;
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_min_length 256;
gzip_types
    text/plain
    text/css
    text/javascript
    application/javascript
    application/json
    application/xml
    application/rss+xml
    image/svg+xml
    font/woff2
    application/vnd.ms-fontobject;

# Cache static assets (fonts, CSS, JS) for 1 year
location ~* \.(woff|woff2|ttf|eot|css|js)$ {
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Content-Type-Options "nosniff" always;
    access_log off;
}

# Storage images: cache + WebP auto-serve
# For image.jpg, checks if image.jpg.webp exists on disk.
# If browser supports WebP AND .webp file exists, serves the WebP version.
# Original URL stays the same (transparent to the application).
location /storage/ {
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Content-Type-Options "nosniff" always;
    add_header Vary Accept;
    access_log off;

    # WebP auto-serve: if browser supports WebP, try .webp version first
    set $webp "";
    if ($http_accept ~* "image/webp") {
        set $webp "A";
    }
    if (-f $request_filename.webp) {
        set $webp "${webp}B";
    }
    if ($webp = "AB") {
        rewrite ^(.+)$ $1.webp break;
    }

    # Enable gzip for SVG
    gzip_static on;
    gzip on;
    gzip_types image/svg+xml;
}

# Other static images (outside /storage/) - just cache
location ~* \.(jpg|jpeg|png|gif|webp|svg|ico)$ {
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Content-Type-Options "nosniff" always;
    access_log off;
}

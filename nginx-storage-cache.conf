# =============================================================================
# Nginx Cache Headers for Storage Images
# =============================================================================
# Add this to the server block of core.tixello.com nginx configuration.
#
# Location: usually /etc/nginx/sites-available/core.tixello.com
# or /etc/nginx/conf.d/core.tixello.com.conf
#
# After adding, test and reload:
#   sudo nginx -t && sudo systemctl reload nginx
#
# Verify with: curl -I https://core.tixello.com/storage/some-image.jpg
# Should show: Cache-Control: public, max-age=31536000, immutable
# =============================================================================

# Cache static assets (images, fonts, CSS, JS) for 1 year
# Safe because filenames change on re-upload (Filament adds random hash)
location ~* \.(jpg|jpeg|png|gif|webp|svg|ico|woff|woff2|ttf|eot|css|js)$ {
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Content-Type-Options "nosniff" always;
    access_log off;
}

# Specifically for /storage/ path - ensure images are cached
location /storage/ {
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Content-Type-Options "nosniff" always;
    access_log off;

    # Enable gzip for SVG
    gzip_static on;
    gzip on;
    gzip_types image/svg+xml;
}

# =============================================================================
# Optional: WebP auto-serve (serve .webp if browser supports it)
# =============================================================================
# Uncomment after running: php artisan media:compress --webp --keep-original
#
# location ~* \.(jpg|jpeg|png)$ {
#     add_header Vary Accept;
#     expires 1y;
#     add_header Cache-Control "public, max-age=31536000, immutable";
#
#     # If browser supports webp AND webp version exists, serve it
#     set $webp "";
#     if ($http_accept ~* "image/webp") {
#         set $webp "A";
#     }
#     if (-f $request_filename.webp) {
#         set $webp "${webp}B";
#     }
#     if ($webp = "AB") {
#         rewrite ^(.+)\.(jpg|jpeg|png)$ $1.$2.webp break;
#     }
# }

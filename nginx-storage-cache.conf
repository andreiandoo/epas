# =============================================================================
# Nginx Cache Headers + WebP Auto-Serve for Storage Images
# =============================================================================
# Add this to the server block of core.tixello.com nginx configuration.
#
# Location: usually /etc/nginx/sites-available/core.tixello.com
# or /etc/nginx/conf.d/core.tixello.com.conf
#
# After adding, test and reload:
#   sudo nginx -t && sudo systemctl reload nginx
#
# Verify cache: curl -I https://core.tixello.com/storage/some-image.jpg
#   Should show: Cache-Control: public, max-age=31536000, immutable
#
# Verify WebP: curl -I -H "Accept: image/webp" https://core.tixello.com/storage/some-image.jpg
#   Should show: Content-Type: image/webp (if .webp version exists)
#
# Prerequisites:
#   php artisan storage:convert-webp          (create .webp versions)
#   php artisan storage:convert-webp --dry-run (preview without changes)
# =============================================================================

# Cache static assets (fonts, CSS, JS) for 1 year
location ~* \.(woff|woff2|ttf|eot|css|js)$ {
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Content-Type-Options "nosniff" always;
    access_log off;
}

# Storage images: cache + WebP auto-serve
# For image.jpg, checks if image.jpg.webp exists on disk.
# If browser supports WebP AND .webp file exists, serves the WebP version.
# Original URL stays the same (transparent to the application).
location /storage/ {
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Content-Type-Options "nosniff" always;
    add_header Vary Accept;
    access_log off;

    # WebP auto-serve: if browser supports WebP, try .webp version first
    set $webp "";
    if ($http_accept ~* "image/webp") {
        set $webp "A";
    }
    if (-f $request_filename.webp) {
        set $webp "${webp}B";
    }
    if ($webp = "AB") {
        rewrite ^(.+)$ $1.webp break;
    }

    # Enable gzip for SVG
    gzip_static on;
    gzip on;
    gzip_types image/svg+xml;
}

# Other static images (outside /storage/) - just cache
location ~* \.(jpg|jpeg|png|gif|webp|svg|ico)$ {
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    add_header X-Content-Type-Options "nosniff" always;
    access_log off;
}

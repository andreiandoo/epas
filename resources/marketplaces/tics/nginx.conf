
# =============================================================================
# CITY PAGES - Must be FIRST (before any /evenimente rules)
# =============================================================================

# City pages: /evenimente-bucuresti -> city.php?city=bucuresti
# This MUST be before the /evenimente exact match
location ~ "^/evenimente-([a-z0-9-]+)/?$" {
    rewrite ^/evenimente-([a-z0-9-]+)/?$ /city.php?city=$1 last;
}

# Redirect old city URLs to new format (301 permanent redirect)
location ~ "^/oras/([a-z0-9-]+)/?$" {
    return 301 /evenimente-$1;
}

# =============================================================================
# VENUE PAGES
# =============================================================================

# Venue pages: /bilete-arena-nationala -> venue.php?venue=arena-nationala
location ~ "^/bilete-([a-z0-9-]+)/?$" {
    rewrite ^/bilete-([a-z0-9-]+)/?$ /venue.php?venue=$1 last;
}

# =============================================================================
# EVENT PAGES
# =============================================================================

# Short event URL: /e/coldplay-bucuresti-2026 -> event.php?slug=xxx
location ~ "^/e/([a-z0-9-]+)/?$" {
    rewrite ^/e/([a-z0-9-]+)/?$ /event.php?slug=$1 last;
}

# Event pages: /bilete/concert-coldplay-bucuresti -> event.php?fullslug=xxx
location ~ "^/bilete/([a-z0-9-]+)/?$" {
    rewrite ^/bilete/([a-z0-9-]+)/?$ /event.php?fullslug=$1 last;
}

# =============================================================================
# EVENTS LISTING
# =============================================================================

# Events listing: /evenimente (exact match)
location = /evenimente {
    rewrite ^ /events.php last;
}

# Events listing with trailing slash
location = /evenimente/ {
    rewrite ^ /events.php last;
}

# Events by category: /evenimente/concerte
location ~ "^/evenimente/([a-z0-9-]+)/?$" {
    rewrite ^/evenimente/([a-z0-9-]+)/?$ /events.php?categorie=$1 last;
}

# Category page: /categorie/concerte
location ~ "^/categorie/([a-z0-9-]+)/?$" {
    rewrite ^/categorie/([a-z0-9-]+)/?$ /event-category.php?categorie=$1 last;
}

# =============================================================================
# AUTH PAGES
# =============================================================================

location = /conectare {
    rewrite ^ /login.php last;
}

location = /inregistrare {
    rewrite ^ /register.php last;
}

location = /parola-uitata {
    rewrite ^ /forgot-password.php last;
}

# =============================================================================
# CART & CHECKOUT
# =============================================================================

location = /cos {
    rewrite ^ /cart.php last;
}

location = /checkout {
    rewrite ^ /checkout.php last;
}

# =============================================================================
# USER ACCOUNT PAGES
# =============================================================================

# User dashboard: /cont -> user/dashboard.php
location = /cont {
    rewrite ^ /user/dashboard.php last;
}
location = /cont/ {
    rewrite ^ /user/dashboard.php last;
}

# User tickets: /cont/bilete -> user/tickets.php
location ~ "^/cont/bilete/?$" {
    rewrite ^ /user/tickets.php last;
}

# User orders: /cont/comenzi -> user/orders.php
location ~ "^/cont/comenzi/?$" {
    rewrite ^ /user/orders.php last;
}

# User favorites: /cont/favorite -> user/favorites.php
location ~ "^/cont/favorite/?$" {
    rewrite ^ /user/favorites.php last;
}

# User rewards: /cont/puncte -> user/rewards.php
location ~ "^/cont/puncte/?$" {
    rewrite ^ /user/rewards.php last;
}

# User settings: /cont/setari -> user/settings.php
location ~ "^/cont/setari/?$" {
    rewrite ^ /user/settings.php last;
}

# User logout
location = /deconectare {
    rewrite ^ /logout.php last;
}

# =============================================================================
# ORGANIZER PAGES
# =============================================================================

# Organizer dashboard: /organizator -> organizer/dashboard.php
location = /organizator {
    rewrite ^ /organizer/dashboard.php last;
}
location = /organizator/ {
    rewrite ^ /organizer/dashboard.php last;
}

# Organizer events list
location ~ "^/organizator/evenimente/?$" {
    rewrite ^ /organizer/events.php last;
}

# Organizer create event
location ~ "^/organizator/eveniment-nou/?$" {
    rewrite ^ /organizer/create-event.php last;
}

# Organizer edit event: /organizator/edit/{id}
location ~ "^/organizator/edit/([a-z0-9-]+)/?$" {
    rewrite ^/organizator/edit/([a-z0-9-]+)/?$ /organizer/event-edit.php?id=$1 last;
}

# Organizer event analytics: /organizator/analytics/{id}
location ~ "^/organizator/analytics/([a-z0-9-]+)/?$" {
    rewrite ^/organizator/analytics/([a-z0-9-]+)/?$ /organizer/analytics.php?id=$1 last;
}

# Organizer event report: /organizator/report/{id}
location ~ "^/organizator/report/([a-z0-9-]+)/?$" {
    rewrite ^/organizator/report/([a-z0-9-]+)/?$ /organizer/report.php?id=$1 last;
}

# Organizer event documents: /organizator/documents/{id}
location ~ "^/organizator/documents/([a-z0-9-]+)/?$" {
    rewrite ^/organizator/documents/([a-z0-9-]+)/?$ /organizer/documents.php?id=$1 last;
}

# Organizer event invitations: /organizator/invitations/{id}
location ~ "^/organizator/invitations/([a-z0-9-]+)/?$" {
    rewrite ^/organizator/invitations/([a-z0-9-]+)/?$ /organizer/invitations.php?id=$1 last;
}

# Organizer event sales: /organizator/sales/{id}
location ~ "^/organizator/sales/([a-z0-9-]+)/?$" {
    rewrite ^/organizator/sales/([a-z0-9-]+)/?$ /organizer/sales.php?id=$1 last;
}

# Organizer finance
location ~ "^/organizator/finante/?$" {
    rewrite ^ /organizer/finance.php last;
}

# Organizer payouts
location ~ "^/organizator/plati/?$" {
    rewrite ^ /organizer/payouts.php last;
}

# Organizer scanner
location ~ "^/organizator/scanner/?$" {
    rewrite ^ /organizer/scanner.php last;
}

# Organizer team
location ~ "^/organizator/echipa/?$" {
    rewrite ^ /organizer/team.php last;
}

# Organizer widget
location ~ "^/organizator/widget/?$" {
    rewrite ^ /organizer/widget.php last;
}

# Organizer settings
location ~ "^/organizator/setari/?$" {
    rewrite ^ /organizer/settings.php last;
}

# Organizer auth
location ~ "^/organizator/conectare/?$" {
    rewrite ^ /organizer/login.php last;
}
location ~ "^/organizator/inregistrare/?$" {
    rewrite ^ /organizer/register.php last;
}

# =============================================================================
# API PROXY
# =============================================================================

# API endpoints - exclude .php files to prevent infinite rewrite loop
# The negative lookahead (?!.*\.php$) ensures proxy.php gets processed by PHP-FPM
location ~ "^/api/(?!.*\.php$)(.*)$" {
    rewrite ^/api/(.*)$ /api/proxy.php?endpoint=$1 last;
}

# =============================================================================
# ERROR PAGES
# =============================================================================

error_page 404 /404.php;

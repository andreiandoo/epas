<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coș de cumpărături — Ambilet</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'sans': ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: {
                        'primary': '#A51C30',
                        'primary-dark': '#8B1728',
                        'secondary': '#1E293B',
                        'accent': '#E67E22',
                        'surface': '#F8FAFC',
                        'muted': '#64748B',
                        'border': '#E2E8F0',
                        'success': '#10B981',
                        'warning': '#F59E0B',
                        'error': '#EF4444',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="/assets/css/custom.css">
</head>
<body class="bg-surface">
    <div id="header"></div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8">
        <!-- Progress Steps -->
        <div class="flex items-center justify-center mb-8">
            <div class="flex items-center">
                <div class="flex items-center justify-center w-10 h-10 bg-primary text-white rounded-full font-bold">1</div>
                <span class="ml-2 font-semibold text-primary">Coș</span>
            </div>
            <div class="w-16 h-0.5 bg-border mx-4"></div>
            <div class="flex items-center">
                <div class="flex items-center justify-center w-10 h-10 bg-border text-muted rounded-full font-bold">2</div>
                <span class="ml-2 text-muted">Checkout</span>
            </div>
            <div class="w-16 h-0.5 bg-border mx-4"></div>
            <div class="flex items-center">
                <div class="flex items-center justify-center w-10 h-10 bg-border text-muted rounded-full font-bold">3</div>
                <span class="ml-2 text-muted">Confirmare</span>
            </div>
        </div>

        <!-- Timer Warning -->
        <div id="timer-warning" class="hidden mb-6 bg-warning/10 border border-warning/30 rounded-xl p-4">
            <div class="flex items-center gap-3">
                <svg class="w-6 h-6 text-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div>
                    <p class="font-semibold text-secondary">Rezervare în curs</p>
                    <p class="text-sm text-muted">Biletele sunt rezervate pentru <span id="timer" class="font-bold text-warning">15:00</span></p>
                </div>
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Cart Items -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl border border-border overflow-hidden">
                    <div class="p-6 border-b border-border">
                        <h1 class="text-2xl font-bold text-secondary">Coșul tău</h1>
                    </div>

                    <div id="cart-items" class="divide-y divide-border">
                        <!-- Cart items will be rendered here -->
                    </div>

                    <div id="empty-cart" class="hidden p-12 text-center">
                        <svg class="w-20 h-20 text-muted mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        <h2 class="text-xl font-bold text-secondary mb-2">Coșul tău este gol</h2>
                        <p class="text-muted mb-6">Descoperă evenimente și adaugă bilete în coș</p>
                        <a href="/" class="btn btn-primary">Explorează evenimente</a>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="lg:col-span-1">
                <div id="order-summary" class="sticky top-24 bg-white rounded-2xl border border-border overflow-hidden">
                    <div class="p-6 border-b border-border">
                        <h2 class="text-lg font-bold text-secondary">Sumar comandă</h2>
                    </div>

                    <div class="p-6">
                        <!-- Summary content will be rendered here -->
                    </div>
                </div>

                <!-- Promo Code -->
                <div class="mt-4 bg-white rounded-2xl border border-border p-6">
                    <h3 class="font-semibold text-secondary mb-3">Cod promoțional</h3>
                    <div class="flex gap-2">
                        <input type="text" id="promo-input" placeholder="Introdu codul"
                               class="input flex-1">
                        <button id="apply-promo" class="btn btn-secondary">Aplică</button>
                    </div>
                    <div id="promo-message" class="hidden mt-2 text-sm"></div>
                </div>

                <!-- Trust Badges -->
                <div class="mt-6 space-y-3 text-sm text-muted">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                        <span>Plată securizată SSL 256-bit</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        <span>Bilete livrate instant pe email</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span>Garanție 100% bilete valide</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="footer"></div>

    <script src="/assets/js/config.js"></script>
    <script src="/assets/js/utils.js"></script>
    <script src="/assets/js/api.js"></script>
    <script src="/assets/js/auth.js"></script>
    <script src="/assets/js/cart.js"></script>
    <script src="/assets/js/components/header.js"></script>
    <script src="/assets/js/components/footer.js"></script>
    <script src="/assets/js/components/notifications.js"></script>

    <script>
        const CartPage = {
            timerInterval: null,

            init() {
                this.render();
                this.bindEvents();
                this.startTimer();
            },

            render() {
                const cart = AmbiletCart.getCart();
                const itemsContainer = document.getElementById('cart-items');
                const emptyCart = document.getElementById('empty-cart');

                if (cart.items.length === 0) {
                    itemsContainer.innerHTML = '';
                    emptyCart.classList.remove('hidden');
                    document.getElementById('order-summary').querySelector('.p-6:last-child').innerHTML = `
                        <p class="text-center text-muted">Coșul este gol</p>
                    `;
                    return;
                }

                emptyCart.classList.add('hidden');

                // Render items
                itemsContainer.innerHTML = cart.items.map(item => `
                    <div class="p-6 flex gap-4" data-item-key="${item.key}">
                        <div class="w-24 h-24 rounded-xl overflow-hidden shrink-0">
                            <img src="${item.event.image || AMBILET_CONFIG.PLACEHOLDER_EVENT}"
                                 alt="${item.event.title}"
                                 class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="font-semibold text-secondary truncate">${item.event.title}</h3>
                            <p class="text-sm text-muted">
                                ${AmbiletUtils.formatDate(item.event.date, 'medium')}
                                ${item.event.venue ? ` • ${item.event.venue}` : ''}
                            </p>
                            <div class="mt-2">
                                <span class="inline-flex items-center px-2 py-1 bg-surface rounded text-sm font-medium">
                                    ${item.ticketType.name}
                                </span>
                            </div>
                            <div class="flex items-center justify-between mt-3">
                                <div class="flex items-center gap-2">
                                    <button onclick="CartPage.updateQuantity('${item.key}', -1)"
                                            class="w-8 h-8 rounded-lg border border-border hover:bg-surface flex items-center justify-center">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                                        </svg>
                                    </button>
                                    <span class="w-8 text-center font-semibold">${item.quantity}</span>
                                    <button onclick="CartPage.updateQuantity('${item.key}', 1)"
                                            class="w-8 h-8 rounded-lg border border-border hover:bg-surface flex items-center justify-center">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                        </svg>
                                    </button>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-primary">${AmbiletUtils.formatCurrency(item.ticketType.price * item.quantity)}</div>
                                    ${item.ticketType.originalPrice && item.ticketType.originalPrice > item.ticketType.price ? `
                                    <div class="text-sm text-muted line-through">${AmbiletUtils.formatCurrency(item.ticketType.originalPrice * item.quantity)}</div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        <button onclick="CartPage.removeItem('${item.key}')"
                                class="p-2 text-muted hover:text-error hover:bg-red-50 rounded-lg transition-colors self-start">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                `).join('');

                this.renderSummary();
            },

            renderSummary() {
                const summary = AmbiletCart.getSummary();
                const container = document.getElementById('order-summary').querySelector('.p-6:last-child');

                if (summary.itemCount === 0) {
                    container.innerHTML = `<p class="text-center text-muted">Coșul este gol</p>`;
                    return;
                }

                const promo = summary.promoCode;

                container.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-muted">Subtotal (${summary.itemCount} bilete)</span>
                            <span class="font-medium">${AmbiletUtils.formatCurrency(summary.subtotal)}</span>
                        </div>

                        ${summary.savings > 0 ? `
                        <div class="flex justify-between text-sm text-success">
                            <span>Economisești</span>
                            <span>-${AmbiletUtils.formatCurrency(summary.savings)}</span>
                        </div>
                        ` : ''}

                        <div class="flex justify-between text-sm">
                            <span class="text-muted">Taxă Crucea Roșie (1%)</span>
                            <span class="font-medium">${AmbiletUtils.formatCurrency(summary.redCrossTax)}</span>
                        </div>

                        ${promo ? `
                        <div class="flex justify-between text-sm text-success">
                            <span class="flex items-center gap-1">
                                <span>Cod: ${promo.code}</span>
                                <button onclick="CartPage.removePromo()" class="text-muted hover:text-error">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </span>
                            <span>-${AmbiletUtils.formatCurrency(summary.promoDiscount)}</span>
                        </div>
                        ` : ''}

                        <div class="border-t border-border pt-3 mt-3">
                            <div class="flex justify-between text-lg font-bold">
                                <span>Total</span>
                                <span class="text-primary">${AmbiletUtils.formatCurrency(summary.total)}</span>
                            </div>
                            <p class="text-xs text-muted text-right mt-1">
                                Vei câștiga ${summary.pointsEarned} puncte
                            </p>
                        </div>
                    </div>

                    <a href="/checkout.html" class="btn btn-primary w-full mt-6">
                        Continuă către checkout
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                        </svg>
                    </a>

                    <a href="/" class="block text-center text-sm text-muted hover:text-primary mt-4">
                        ← Continuă cumpărăturile
                    </a>
                `;
            },

            bindEvents() {
                // Promo code
                document.getElementById('apply-promo')?.addEventListener('click', () => this.applyPromo());
                document.getElementById('promo-input')?.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') this.applyPromo();
                });

                // Listen for cart changes
                window.addEventListener('ambilet:cart:update', () => this.render());
            },

            updateQuantity(itemKey, delta) {
                const cart = AmbiletCart.getCart();
                const item = cart.items.find(i => i.key === itemKey);
                if (item) {
                    AmbiletCart.updateQuantity(itemKey, item.quantity + delta);
                }
            },

            removeItem(itemKey) {
                AmbiletCart.removeItem(itemKey);
            },

            async applyPromo() {
                const input = document.getElementById('promo-input');
                const messageEl = document.getElementById('promo-message');
                const code = input.value.trim();

                if (!code) {
                    messageEl.textContent = 'Introdu un cod promoțional';
                    messageEl.className = 'mt-2 text-sm text-error';
                    messageEl.classList.remove('hidden');
                    return;
                }

                const result = await AmbiletCart.applyPromoCode(code);

                if (result.success) {
                    messageEl.textContent = 'Cod aplicat cu succes!';
                    messageEl.className = 'mt-2 text-sm text-success';
                    input.value = '';
                    this.renderSummary();
                } else {
                    messageEl.textContent = result.message || 'Cod invalid';
                    messageEl.className = 'mt-2 text-sm text-error';
                }
                messageEl.classList.remove('hidden');
            },

            removePromo() {
                AmbiletCart.removePromoCode();
                this.renderSummary();
            },

            startTimer() {
                const cart = AmbiletCart.getCart();
                if (cart.items.length === 0) return;

                // Start reservation if not already started
                if (!AmbiletCart.getReservationExpiry()) {
                    AmbiletCart.startReservationTimer();
                }

                document.getElementById('timer-warning').classList.remove('hidden');

                this.timerInterval = setInterval(() => {
                    const remaining = AmbiletCart.getRemainingTime();
                    document.getElementById('timer').textContent = AmbiletCart.formatRemainingTime();

                    if (remaining <= 0) {
                        clearInterval(this.timerInterval);
                        toast.warning('Timpul de rezervare a expirat');
                        // Optionally clear cart or redirect
                    }
                }, 1000);
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            CartPage.init();
        });
    </script>
</body>
</html>

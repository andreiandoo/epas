<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tixello Analytics - Event Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
        [x-cloak] { display: none !important; }
        .stat-card { background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%); backdrop-filter: blur(10px); }
        .forecast-card { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); }
        .pulse-ring { animation: pulse-ring 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite; }
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }
        .milestone-card { transition: all 0.2s ease; }
        .milestone-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        @keyframes avatarPulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 50% { box-shadow: 0 0 0 8px rgba(16, 185, 129, 0); } }
        
        /* Leaflet fixes */
        #globeMap { background: #f8fafc !important; z-index: 1; }
        .leaflet-container { background: #f8fafc !important; width: 100% !important; height: 100% !important; }
        .leaflet-pane { z-index: 1 !important; }
        .leaflet-tile-pane { z-index: 1 !important; }
        .leaflet-overlay-pane { z-index: 2 !important; }
        .leaflet-marker-pane { z-index: 3 !important; }
        .leaflet-popup-pane { z-index: 4 !important; }
        .custom-avatar-marker { background: transparent !important; border: none !important; }
        .leaflet-popup-content-wrapper { border-radius: 12px !important; padding: 0 !important; box-shadow: 0 10px 40px rgba(0,0,0,0.15) !important; }
        .leaflet-popup-content { margin: 0 !important; }
        .leaflet-popup-tip { background: #fff !important; }
        .leaflet-control-zoom { margin-bottom: 100px !important; margin-right: 20px !important; border: none !important; box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important; }
        .leaflet-control-zoom a { background: #fff !important; color: #334155 !important; border: none !important; }
        .leaflet-control-zoom a:hover { background: #f1f5f9 !important; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <div x-data="eventDashboard()" x-init="init()" x-cloak>
        <!-- Top Navigation -->
        <div class="bg-white border-b border-gray-200 sticky top-0 z-40">
            <div class="max-w-[1500px] mx-auto px-6 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <!-- Event Mode Tabs -->
                        <div class="flex items-center bg-gray-100 rounded-xl p-1">
                            <button @click="switchToLive()" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all" :class="eventMode === 'live' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500 hover:text-gray-700'">
                                <span x-show="eventMode === 'live'" class="relative flex h-2 w-2">
                                    <span class="pulse-ring absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                                </span>
                                <span>Live Events</span>
                                <span class="px-1.5 py-0.5 bg-emerald-100 text-emerald-700 text-xs rounded-full" x-text="liveEvents.length"></span>
                            </button>
                            <button @click="switchToPast()" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-all" :class="eventMode === 'past' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500 hover:text-gray-700'">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                <span>Past Events</span>
                                <span class="px-1.5 py-0.5 bg-gray-200 text-gray-600 text-xs rounded-full" x-text="pastEvents.length"></span>
                            </button>
                        </div>
                        
                        <!-- Event Dropdown -->
                        <div class="relative">
                            <button @click="eventDropdown = !eventDropdown" class="flex items-center gap-3 px-4 py-2.5 bg-gray-50 hover:bg-gray-100 rounded-xl border border-gray-200 transition-all min-w-[320px]">
                                <div class="w-10 h-10 rounded-lg overflow-hidden flex-shrink-0 shadow-sm">
                                    <img :src="getSelectedEvent().image" class="w-full h-full object-cover">
                                </div>
                                <div class="text-left flex-1">
                                    <div class="text-sm font-semibold text-gray-800" x-text="getSelectedEvent().name"></div>
                                    <div class="text-[11px] text-gray-500" x-text="getSelectedEvent().date + ' â€¢ ' + getSelectedEvent().venue"></div>
                                </div>
                                <svg class="w-4 h-4 text-gray-400 transition-transform" :class="eventDropdown ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </button>
                            <div x-show="eventDropdown" @click.away="eventDropdown = false" x-transition class="absolute top-full left-0 mt-2 w-full bg-white rounded-xl shadow-xl border border-gray-100 overflow-hidden z-50 max-h-[400px] overflow-y-auto">
                                <div class="p-2">
                                    <template x-for="event in currentEventsList" :key="event.id">
                                        <button @click="selectEvent(event); eventDropdown = false" class="w-full flex items-center gap-3 px-3 py-3 rounded-xl hover:bg-violet-50 transition-colors text-left" :class="selectedEvent && selectedEvent.id === event.id ? 'bg-violet-50 border border-violet-200' : ''">
                                            <div class="w-12 h-12 rounded-lg overflow-hidden flex-shrink-0 shadow-sm"><img :src="event.image" class="w-full h-full object-cover"></div>
                                            <div class="flex-1 min-w-0">
                                                <div class="text-sm font-semibold text-gray-800 truncate" x-text="event.name"></div>
                                                <div class="text-[11px] text-gray-500 mt-0.5" x-text="event.date + ' â€¢ ' + event.venue"></div>
                                                <div class="flex items-center gap-3 mt-1">
                                                    <span class="text-xs text-gray-600 font-medium" x-text="formatCurrency(event.revenue)"></span>
                                                </div>
                                            </div>
                                        </button>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <!-- Period Selector -->
                        <div class="flex items-center bg-gray-100 rounded-xl p-1">
                            <button @click="selectPeriod('7d')" class="px-3 py-1.5 text-xs font-medium rounded-lg transition-all" :class="period === '7d' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500'">7D</button>
                            <button @click="selectPeriod('30d')" class="px-3 py-1.5 text-xs font-medium rounded-lg transition-all" :class="period === '30d' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500'">30D</button>
                            <button @click="selectPeriod('all')" class="px-3 py-1.5 text-xs font-medium rounded-lg transition-all" :class="period === 'all' ? 'bg-white shadow-sm text-gray-900' : 'text-gray-500'">All</button>
                        </div>
                        
                        <!-- Live indicator (clickable) -->
                        <button x-show="eventMode === 'live'" @click="openGlobeModal()" class="flex items-center gap-2 px-3 py-2 bg-emerald-50 hover:bg-emerald-100 rounded-xl border border-emerald-200 transition-colors cursor-pointer">
                            <span class="relative flex h-2.5 w-2.5"><span class="pulse-ring absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-500"></span></span>
                            <span class="text-sm font-medium text-emerald-700" x-text="liveVisitors + ' online'"></span>
                            <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        </button>
                        
                        <!-- Add Milestone -->
                        <button x-show="eventMode === 'live'" @click="milestoneModal = true" class="flex items-center gap-2 px-4 py-2.5 bg-gradient-to-r from-violet-500 to-purple-600 text-white text-sm font-medium rounded-xl hover:shadow-lg transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            <span>Add Milestone</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Past Event Banner -->
        <div x-show="eventMode === 'past'" class="bg-gradient-to-r from-slate-700 to-slate-800 text-white">
            <div class="max-w-[1500px] mx-auto px-6 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <svg class="w-5 h-5 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        <span class="text-sm font-medium">Event Report</span>
                        <span class="text-xs text-slate-400">Historical data view</span>
                    </div>
                    <button class="flex items-center gap-2 px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded-lg text-sm transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        Export Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-[1500px] mx-auto px-6 py-6">
            <!-- Stats Cards -->
            <div class="grid grid-cols-5 gap-4 mb-6">
                <div class="stat-card rounded-2xl p-5 border border-white/50 shadow-sm">
                    <div class="flex items-center justify-between mb-3">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-emerald-400 to-emerald-600 flex items-center justify-center"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                        <span class="flex items-center gap-1 text-xs font-medium px-2 py-1 rounded-full bg-emerald-100 text-emerald-700">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
                            <span x-text="getSelectedEvent().revenueChange + '%'"></span>
                        </span>
                    </div>
                    <div class="text-2xl font-bold text-gray-900" x-text="formatCurrency(getSelectedEvent().revenue)"></div>
                    <div class="text-xs text-gray-500 mt-1">Total Revenue</div>
                    <div class="mt-3 flex items-center gap-2"><div class="flex-1 h-1.5 bg-gray-100 rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-emerald-400 to-emerald-500 rounded-full" :style="'width:' + Math.min((getSelectedEvent().revenue / getSelectedEvent().revenueTarget) * 100, 100) + '%'"></div></div><span class="text-[10px] text-gray-400" x-text="Math.round((getSelectedEvent().revenue / getSelectedEvent().revenueTarget) * 100) + '%'"></span></div>
                </div>
                
                <div class="stat-card rounded-2xl p-5 border border-white/50 shadow-sm">
                    <div class="flex items-center justify-between mb-3">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/></svg></div>
                        <span x-show="eventMode === 'live'" class="text-xs font-medium px-2 py-1 rounded-full bg-blue-100 text-blue-700" x-text="'+' + getSelectedEvent().ticketsToday + ' today'"></span>
                    </div>
                    <div class="text-2xl font-bold text-gray-900" x-text="getSelectedEvent().ticketsSold.toLocaleString()"></div>
                    <div class="text-xs text-gray-500 mt-1">Tickets Sold</div>
                    <div class="mt-3 flex items-center gap-2"><div class="flex-1 h-1.5 bg-gray-100 rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-blue-400 to-blue-500 rounded-full" :style="'width:' + (getSelectedEvent().ticketsSold / getSelectedEvent().capacity * 100) + '%'"></div></div><span class="text-[10px] text-gray-400" x-text="Math.round(getSelectedEvent().ticketsSold / getSelectedEvent().capacity * 100) + '%'"></span></div>
                </div>
                
                <div class="stat-card rounded-2xl p-5 border border-white/50 shadow-sm">
                    <div class="flex items-center justify-between mb-3"><div class="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-400 to-cyan-600 flex items-center justify-center"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg></div></div>
                    <div class="text-2xl font-bold text-gray-900" x-text="getSelectedEvent().totalVisits.toLocaleString()"></div>
                    <div class="text-xs text-gray-500 mt-1">Total Visits</div>
                    <div class="mt-3 text-[11px] text-gray-400" x-text="getSelectedEvent().uniqueVisitors.toLocaleString() + ' unique'"></div>
                </div>
                
                <div class="stat-card rounded-2xl p-5 border border-white/50 shadow-sm">
                    <div class="flex items-center justify-between mb-3"><div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg></div></div>
                    <div class="text-2xl font-bold text-gray-900" x-text="getSelectedEvent().conversionRate + '%'"></div>
                    <div class="text-xs text-gray-500 mt-1">Conversion Rate</div>
                    <div class="mt-3 text-[11px] text-gray-400">Visits â†’ Purchases</div>
                </div>
                
                <div class="stat-card rounded-2xl p-5 border border-white/50 shadow-sm">
                    <div class="flex items-center justify-between mb-3">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-rose-400 to-pink-600 flex items-center justify-center"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></div>
                        <span class="text-xs font-medium px-2 py-1 rounded-full" :class="eventMode === 'live' ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-600'" x-text="eventMode === 'live' ? getSelectedEvent().status : 'Completed'"></span>
                    </div>
                    <div class="text-2xl font-bold text-gray-900" x-text="eventMode === 'live' ? getSelectedEvent().daysUntil : 'â€”'"></div>
                    <div class="text-xs text-gray-500 mt-1" x-text="eventMode === 'live' ? 'Days Until Event' : 'Event Ended'"></div>
                    <div class="mt-3 text-[11px] text-gray-400" x-text="getSelectedEvent().date"></div>
                </div>
            </div>

            <!-- Chart + Forecast -->
            <div class="grid grid-cols-3 gap-6 mb-6">
                <div class="col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div><h2 class="text-lg font-semibold text-gray-900">Performance Overview</h2><p class="text-xs text-gray-500">Click to toggle metrics</p></div>
                        <div class="flex items-center gap-2">
                            <template x-for="m in chartMetrics" :key="m.key">
                                <button @click="toggleMetric(m.key)" class="flex items-center gap-2 px-3 py-1.5 rounded-lg border transition-all" :class="m.active ? 'border-transparent shadow-sm' : 'border-gray-200 opacity-50'" :style="m.active ? 'background:' + m.color + '15' : ''">
                                    <div class="w-2.5 h-2.5 rounded-full" :style="'background:' + m.color"></div>
                                    <span class="text-xs font-medium" :style="m.active ? 'color:' + m.color : 'color:#9ca3af'" x-text="m.label"></span>
                                </button>
                            </template>
                        </div>
                    </div>
                    <div id="mainChart" class="h-[300px]"></div>
                </div>
                
                <!-- Forecast (live) -->
                <div x-show="eventMode === 'live'" class="forecast-card rounded-2xl p-6 text-white">
                    <div class="flex items-center gap-3 mb-5">
                        <div class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg></div>
                        <div><h2 class="text-lg font-semibold">AI Forecast</h2><p class="text-xs text-white/60">Predictions</p></div>
                    </div>
                    <div class="bg-white/10 rounded-xl p-4 mb-4">
                        <div class="flex items-center justify-between mb-3"><span class="text-sm font-medium text-white/80">Next 3 Days</span><span class="text-xs px-2 py-0.5 bg-emerald-500/30 text-emerald-300 rounded-full">87%</span></div>
                        <div class="grid grid-cols-2 gap-4"><div><div class="text-xl font-bold">125K RON</div><div class="text-xs text-white/50">Revenue</div></div><div><div class="text-xl font-bold">+456</div><div class="text-xs text-white/50">Tickets</div></div></div>
                    </div>
                    <div class="bg-white/10 rounded-xl p-4 mb-4">
                        <div class="flex items-center justify-between mb-3"><span class="text-sm font-medium text-white/80">Next 7 Days</span><span class="text-xs px-2 py-0.5 bg-amber-500/30 text-amber-300 rounded-full">72%</span></div>
                        <div class="grid grid-cols-2 gap-4"><div><div class="text-xl font-bold">312K RON</div><div class="text-xs text-white/50">Revenue</div></div><div><div class="text-xl font-bold">+1,120</div><div class="text-xs text-white/50">Tickets</div></div></div>
                    </div>
                    <a href="tixello-forecast-report.html" class="block w-full py-2.5 bg-white/10 hover:bg-white/20 rounded-xl text-sm font-medium text-center transition-colors">View Detailed Report â†’</a>
                </div>
                
                <!-- Past Summary -->
                <div x-show="eventMode === 'past'" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <div class="flex items-center gap-3 mb-5"><div class="w-10 h-10 rounded-xl bg-gradient-to-br from-slate-400 to-slate-600 flex items-center justify-center"><svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div><div><h2 class="text-lg font-semibold text-gray-900">Final Results</h2><p class="text-xs text-gray-500">Event completed</p></div></div>
                    <div class="space-y-3">
                        <div class="flex justify-between py-2 border-b border-gray-100"><span class="text-sm text-gray-500">Total Revenue</span><span class="text-sm font-bold text-gray-900" x-text="formatCurrency(getSelectedEvent().revenue)"></span></div>
                        <div class="flex justify-between py-2 border-b border-gray-100"><span class="text-sm text-gray-500">Tickets Sold</span><span class="text-sm font-bold text-gray-900" x-text="getSelectedEvent().ticketsSold.toLocaleString()"></span></div>
                        <div class="flex justify-between py-2 border-b border-gray-100"><span class="text-sm text-gray-500">Capacity</span><span class="text-sm font-bold text-emerald-600" x-text="Math.round(getSelectedEvent().ticketsSold / getSelectedEvent().capacity * 100) + '%'"></span></div>
                        <div class="flex justify-between py-2 border-b border-gray-100"><span class="text-sm text-gray-500">Conversion</span><span class="text-sm font-bold text-gray-900" x-text="getSelectedEvent().conversionRate + '%'"></span></div>
                        <div class="flex justify-between py-2"><span class="text-sm text-gray-500">Ad Spend</span><span class="text-sm font-bold text-gray-900" x-text="formatCurrency(getTotalAdSpend())"></span></div>
                    </div>
                </div>
            </div>

            <!-- Tickets & Campaign ROI -->
            <div class="grid grid-cols-3 gap-6 mb-6">
                <div class="col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Ticket Performance</h2>
                    <table class="w-full">
                        <thead><tr class="border-b border-gray-100"><th class="pb-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th><th class="pb-3 text-right text-xs font-medium text-gray-500 uppercase">Price</th><th class="pb-3 text-right text-xs font-medium text-gray-500 uppercase">Sold</th><th class="pb-3 text-right text-xs font-medium text-gray-500 uppercase">Revenue</th><th class="pb-3 text-right text-xs font-medium text-gray-500 uppercase">Conv.</th><th class="pb-3 text-right text-xs font-medium text-gray-500 uppercase">Trend</th></tr></thead>
                        <tbody>
                            <template x-for="t in getSelectedEvent().ticketTypes" :key="t.name">
                                <tr class="border-b border-gray-50">
                                    <td class="py-3"><div class="flex items-center gap-2"><div class="w-2 h-6 rounded-full" :style="'background:' + t.color"></div><span class="text-sm font-medium text-gray-800" x-text="t.name"></span></div></td>
                                    <td class="py-3 text-right text-sm text-gray-600" x-text="t.price + ' RON'"></td>
                                    <td class="py-3 text-right text-sm font-semibold text-gray-900" x-text="t.sold.toLocaleString()"></td>
                                    <td class="py-3 text-right text-sm font-semibold text-gray-900" x-text="formatCurrency(t.revenue)"></td>
                                    <td class="py-3 text-right text-sm font-semibold" :class="t.conversionRate >= 4 ? 'text-emerald-600' : 'text-gray-600'" x-text="t.conversionRate + '%'"></td>
                                    <td class="py-3 text-right"><span class="text-xs font-medium" :class="t.trend >= 0 ? 'text-emerald-600' : 'text-red-600'" x-text="(t.trend >= 0 ? 'â†‘' : 'â†“') + Math.abs(t.trend) + '%'"></span></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
                
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Campaign ROI</h2>
                    <div class="space-y-3">
                        <template x-for="c in getAdCampaigns()" :key="c.id">
                            <div class="p-3 rounded-xl border border-gray-100 hover:border-violet-200 transition-colors">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center gap-2"><span x-text="getMilestoneIcon(c.type)"></span><span class="text-sm font-medium text-gray-800" x-text="c.title"></span></div>
                                    <span class="text-[10px] px-1.5 py-0.5 rounded-full" :class="c.isActive ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-600'" x-text="c.isActive ? 'Active' : 'Ended'"></span>
                                </div>
                                <div class="grid grid-cols-2 gap-2 text-xs">
                                    <div><span class="text-gray-500">Spend:</span> <span class="font-medium" x-text="formatCurrency(c.budget)"></span></div>
                                    <div><span class="text-gray-500">Revenue:</span> <span class="font-medium text-emerald-600" x-text="formatCurrency(c.attributedRevenue)"></span></div>
                                    <div><span class="text-gray-500">CAC:</span> <span class="font-medium" x-text="c.cac + ' RON'"></span></div>
                                    <div><span class="text-gray-500">ROI:</span> <span class="font-semibold" :class="c.roi >= 0 ? 'text-emerald-600' : 'text-red-600'" x-text="(c.roi >= 0 ? '+' : '') + c.roi + '%'"></span></div>
                                </div>
                            </div>
                        </template>
                        <div x-show="getAdCampaigns().length === 0" class="text-center py-6 text-gray-400 text-sm">No ad campaigns</div>
                    </div>
                </div>
            </div>

            <!-- Traffic Sources & Locations -->
            <div class="grid grid-cols-2 gap-6 mb-6">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Traffic Sources</h2>
                    <div class="space-y-3">
                        <template x-for="s in trafficSources" :key="s.name">
                            <div class="flex items-center gap-4 p-3 rounded-xl hover:bg-gray-50 transition-colors">
                                <div class="w-10 h-10 rounded-xl flex items-center justify-center" :style="'background:' + s.color + '22'"><span x-text="s.icon" class="text-lg"></span></div>
                                <div class="flex-1">
                                    <div class="flex items-center justify-between mb-1"><span class="text-sm font-medium text-gray-800" x-text="s.name"></span><span class="text-sm font-semibold text-gray-900" x-text="s.visitors.toLocaleString()"></span></div>
                                    <div class="flex items-center gap-2"><div class="flex-1 h-1.5 bg-gray-100 rounded-full overflow-hidden"><div class="h-full rounded-full" :style="'width:' + s.percent + '%;background:' + s.color"></div></div><span class="text-xs text-gray-400 w-10" x-text="s.percent + '%'"></span></div>
                                </div>
                                <div class="text-right"><div class="text-sm font-medium text-gray-700" x-text="formatCurrency(s.revenue)"></div><div class="text-xs text-gray-400" x-text="s.conversions + ' sales'"></div></div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Top Locations</h2>
                    <div class="space-y-3">
                        <template x-for="l in topLocations" :key="l.city">
                            <div class="flex items-center gap-4 p-3 rounded-xl hover:bg-gray-50 transition-colors">
                                <div class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center text-xl" x-text="l.flag"></div>
                                <div class="flex-1"><div class="text-sm font-medium text-gray-800" x-text="l.city"></div><div class="text-xs text-gray-400" x-text="l.country"></div></div>
                                <div class="text-right"><div class="text-sm font-semibold text-gray-900" x-text="l.tickets.toLocaleString() + ' tickets'"></div><div class="text-xs text-gray-400" x-text="formatCurrency(l.revenue)"></div></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Milestones Timeline -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6">
                <div class="flex items-center justify-between mb-4"><h2 class="text-lg font-semibold text-gray-900">Campaign Milestones</h2><span class="text-xs text-gray-400" x-text="milestones.length + ' total'"></span></div>
                <div class="grid grid-cols-4 gap-4">
                    <template x-for="m in milestones" :key="m.id">
                        <div @click="showMilestoneDetail(m)" class="milestone-card p-4 rounded-xl border border-gray-100 cursor-pointer hover:border-violet-200">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-10 h-10 rounded-xl flex items-center justify-center text-xl" :class="getMilestoneIconClass(m.type)"><span x-text="getMilestoneIcon(m.type)"></span></div>
                                <div class="flex-1 min-w-0"><div class="text-sm font-semibold text-gray-900 truncate" x-text="m.title"></div><div class="text-xs text-gray-500" x-text="m.startDate"></div></div>
                            </div>
                            <div x-show="m.budget" class="grid grid-cols-2 gap-2 mb-3 text-xs">
                                <div class="p-2 bg-gray-50 rounded-lg"><div class="text-gray-500">Budget</div><div class="font-semibold text-gray-900" x-text="formatCurrency(m.budget)"></div></div>
                                <div class="p-2 bg-emerald-50 rounded-lg"><div class="text-gray-500">Revenue</div><div class="font-semibold text-emerald-600" x-text="formatCurrency(m.attributedRevenue || 0)"></div></div>
                            </div>
                            <div x-show="m.roi !== undefined" class="flex items-center justify-between p-2 rounded-lg" :class="m.roi >= 0 ? 'bg-emerald-50' : 'bg-red-50'"><span class="text-xs text-gray-600">ROI</span><span class="text-sm font-bold" :class="m.roi >= 0 ? 'text-emerald-600' : 'text-red-600'" x-text="(m.roi >= 0 ? '+' : '') + m.roi + '%'"></span></div>
                            <div x-show="m.impact && !m.budget" class="mt-2 flex items-center gap-1 text-xs text-emerald-600"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg><span x-text="m.impact"></span></div>
                            <div x-show="!m.budget && !m.impact" class="text-xs text-gray-500 mt-2" x-text="m.description"></div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Recent Sales -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <div class="flex items-center justify-between mb-4"><div><h2 class="text-lg font-semibold text-gray-900">Recent Sales</h2><p class="text-xs text-gray-500">Click buyer for journey details</p></div></div>
                <table class="w-full">
                    <thead><tr class="border-b border-gray-100"><th class="pb-3 text-left text-xs font-medium text-gray-500 uppercase">Buyer</th><th class="pb-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th><th class="pb-3 text-left text-xs font-medium text-gray-500 uppercase">Tickets</th><th class="pb-3 text-left text-xs font-medium text-gray-500 uppercase">Source</th><th class="pb-3 text-left text-xs font-medium text-gray-500 uppercase">Payment</th><th class="pb-3 text-right text-xs font-medium text-gray-500 uppercase">Amount</th></tr></thead>
                    <tbody>
                        <template x-for="s in recentSales" :key="s.id">
                            <tr @click="showBuyerJourney(s)" class="border-b border-gray-50 hover:bg-violet-50/50 cursor-pointer transition-colors">
                                <td class="py-3"><div class="flex items-center gap-3"><div class="w-9 h-9 rounded-full bg-gradient-to-br from-violet-200 to-purple-300 flex items-center justify-center text-xs font-semibold text-violet-700" x-text="s.initials"></div><div><div class="flex items-center gap-2"><span class="text-sm font-medium text-gray-800" x-text="s.name"></span><span x-show="s.isReturning" class="px-1.5 py-0.5 text-[10px] font-medium bg-amber-100 text-amber-700 rounded-full">Returning</span></div><div class="text-xs text-gray-400" x-text="s.email"></div></div></div></td>
                                <td class="py-3 text-sm text-gray-600" x-text="s.date"></td>
                                <td class="py-3 text-sm text-gray-700" x-text="s.quantity + 'x ' + s.ticketType"></td>
                                <td class="py-3"><span class="text-xs px-2 py-1 rounded-full" :class="getSourceClass(s.source)" x-text="s.source"></span></td>
                                <td class="py-3"><div class="flex items-center gap-1.5"><span x-text="s.paymentIcon"></span><span class="text-xs text-gray-600" x-text="s.paymentMethod"></span></div></td>
                                <td class="py-3 text-right text-sm font-semibold text-gray-900" x-text="formatCurrency(s.amount)"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Buyer Journey Modal -->
        <div x-show="buyerModal" x-transition class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
            <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" @click="buyerModal = false"></div>
            <div class="relative min-h-screen flex items-center justify-center p-4">
                <div class="relative bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[85vh] overflow-hidden" @click.stop>
                    <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-violet-200 to-purple-300 flex items-center justify-center text-lg font-semibold text-violet-700" x-text="selectedBuyer ? selectedBuyer.initials : ''"></div>
                            <div>
                                <div class="flex items-center gap-2"><span class="text-lg font-semibold text-gray-900" x-text="selectedBuyer ? selectedBuyer.name : ''"></span><span x-show="selectedBuyer && selectedBuyer.isReturning" class="px-2 py-0.5 text-xs font-medium bg-amber-100 text-amber-700 rounded-full">ðŸ”„ Returning</span><span x-show="selectedBuyer && !selectedBuyer.isReturning" class="px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-700 rounded-full">âœ¨ New</span></div>
                                <div class="text-sm text-gray-500" x-text="selectedBuyer ? selectedBuyer.email : ''"></div>
                            </div>
                        </div>
                        <button @click="buyerModal = false" class="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                    </div>
                    <div class="flex h-[60vh]">
                        <div class="w-72 border-r border-gray-100 p-6 bg-gray-50 overflow-y-auto">
                            <div class="space-y-4">
                                <div><div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Purchase Date</div><div class="text-sm font-medium text-gray-800" x-text="selectedBuyer ? selectedBuyer.date : ''"></div></div>
                                <div><div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Location</div><div class="flex items-center gap-2 text-sm text-gray-800"><span x-text="selectedBuyer ? selectedBuyer.flag : ''"></span><span x-text="selectedBuyer ? selectedBuyer.location : ''"></span></div></div>
                                <div><div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Device</div><div class="text-sm text-gray-800" x-text="selectedBuyer ? selectedBuyer.device : ''"></div></div>
                                <div><div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Browser</div><div class="text-sm text-gray-800" x-text="selectedBuyer ? selectedBuyer.browser : ''"></div></div>
                                <div class="pt-4 border-t border-gray-200"><div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Purchase</div><div class="text-xl font-bold text-gray-900" x-text="selectedBuyer ? formatCurrency(selectedBuyer.amount) : ''"></div><div class="text-sm text-gray-500" x-text="selectedBuyer ? selectedBuyer.quantity + 'x ' + selectedBuyer.ticketType : ''"></div></div>
                                <div><div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Payment Method</div><div class="flex items-center gap-2 text-sm text-gray-800"><span class="text-lg" x-text="selectedBuyer ? selectedBuyer.paymentIcon : ''"></span><span x-text="selectedBuyer ? selectedBuyer.paymentMethod : ''"></span></div></div>
                                <div><div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Source</div><div class="text-sm text-gray-800" x-text="selectedBuyer ? selectedBuyer.source : ''"></div></div>
                                <div><div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Time to Purchase</div><div class="text-sm text-gray-800" x-text="selectedBuyer ? selectedBuyer.timeToPurchase : ''"></div></div>
                                <div x-show="selectedBuyer && selectedBuyer.isReturning" class="pt-4 border-t border-gray-200"><div class="text-xs text-gray-500 uppercase tracking-wider mb-1">Previous Orders</div><div class="text-sm text-gray-800" x-text="selectedBuyer ? selectedBuyer.previousPurchases + ' orders' : ''"></div><div class="text-xs text-gray-500" x-text="selectedBuyer ? 'Lifetime: ' + formatCurrency(selectedBuyer.lifetimeValue) : ''"></div></div>
                            </div>
                        </div>
                        <div class="flex-1 p-6 overflow-y-auto">
                            <div class="text-sm font-medium text-gray-700 mb-4">Customer Journey</div>
                            <div class="relative"><div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200"></div>
                                <div class="space-y-1">
                                    <template x-for="(e, i) in (selectedBuyer ? selectedBuyer.journey : [])" :key="i">
                                        <div class="relative flex gap-4 pl-2">
                                            <div class="w-5 h-5 rounded-full flex items-center justify-center text-xs z-10 flex-shrink-0" :class="{'bg-purple-100': e.type === 'found', 'bg-blue-100': e.type === 'pageview', 'bg-amber-100': e.type === 'event', 'bg-emerald-100': e.type === 'purchase'}"><span x-text="e.type === 'found' ? 'ðŸ”' : e.type === 'pageview' ? 'ðŸ‘' : e.type === 'purchase' ? 'âœ“' : 'âš¡'"></span></div>
                                            <div class="flex-1 pb-4"><div class="flex items-center justify-between"><div class="text-sm text-gray-800" x-html="formatJourneyEvent(e)"></div><span class="text-xs text-gray-400" x-text="e.time"></span></div></div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Milestone Modal -->
        <div x-show="milestoneModal" x-transition class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
            <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" @click="milestoneModal = false"></div>
            <div class="relative min-h-screen flex items-center justify-center p-4">
                <div class="relative bg-white rounded-2xl shadow-2xl max-w-lg w-full" @click.stop>
                    <div class="p-6 border-b border-gray-100"><h3 class="text-lg font-semibold text-gray-900">Add Milestone</h3></div>
                    <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Type</label><div class="grid grid-cols-3 gap-2"><template x-for="t in milestoneTypes" :key="t.value"><button @click="newMilestone.type = t.value" class="p-3 rounded-xl border-2 transition-all text-center" :class="newMilestone.type === t.value ? 'border-violet-500 bg-violet-50' : 'border-gray-200'"><span class="text-lg" x-text="t.icon"></span><div class="text-xs font-medium mt-1" x-text="t.label"></div></button></template></div></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Title</label><input type="text" x-model="newMilestone.title" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:outline-none focus:border-violet-500" placeholder="Campaign name"></div>
                        <div class="grid grid-cols-2 gap-3"><div><label class="block text-sm font-medium text-gray-700 mb-2">Start</label><input type="date" x-model="newMilestone.startDate" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:outline-none focus:border-violet-500"></div><div x-show="isAdCampaign(newMilestone.type)"><label class="block text-sm font-medium text-gray-700 mb-2">End</label><input type="date" x-model="newMilestone.endDate" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:outline-none focus:border-violet-500"></div></div>
                        <div x-show="isAdCampaign(newMilestone.type)"><label class="block text-sm font-medium text-gray-700 mb-2">Budget (RON)</label><input type="number" x-model="newMilestone.budget" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:outline-none focus:border-violet-500" placeholder="0"></div>
                        <div x-show="isAdCampaign(newMilestone.type)"><label class="block text-sm font-medium text-gray-700 mb-2">Targeting</label><input type="text" x-model="newMilestone.targeting" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:outline-none focus:border-violet-500" placeholder="18-35, Music"></div>
                        <div><label class="block text-sm font-medium text-gray-700 mb-2">Notes</label><textarea x-model="newMilestone.description" rows="2" class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:outline-none focus:border-violet-500 resize-none" placeholder="Details..."></textarea></div>
                    </div>
                    <div class="p-6 border-t border-gray-100 flex justify-end gap-3"><button @click="milestoneModal = false" class="px-5 py-2.5 text-gray-600 font-medium">Cancel</button><button @click="addMilestone()" class="px-5 py-2.5 bg-gradient-to-r from-violet-500 to-purple-600 text-white font-medium rounded-xl">Add</button></div>
                </div>
            </div>
        </div>

        <!-- Milestone Detail Modal -->
        <div x-show="milestoneDetailModal" x-transition class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
            <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" @click="milestoneDetailModal = false"></div>
            <div class="relative min-h-screen flex items-center justify-center p-4">
                <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full" @click.stop>
                    <div class="p-6">
                        <div class="flex items-center gap-3 mb-4"><div class="w-12 h-12 rounded-xl flex items-center justify-center text-2xl" :class="getMilestoneIconClass(selectedMilestone ? selectedMilestone.type : '')"><span x-text="getMilestoneIcon(selectedMilestone ? selectedMilestone.type : '')"></span></div><div><div class="text-lg font-semibold text-gray-900" x-text="selectedMilestone ? selectedMilestone.title : ''"></div><div class="text-sm text-gray-500" x-text="selectedMilestone ? selectedMilestone.startDate + (selectedMilestone.endDate ? ' â†’ ' + selectedMilestone.endDate : '') : ''"></div></div></div>
                        <div x-show="selectedMilestone && selectedMilestone.description" class="mb-4 p-3 bg-gray-50 rounded-xl text-sm text-gray-600" x-text="selectedMilestone ? selectedMilestone.description : ''"></div>
                        <div x-show="selectedMilestone && selectedMilestone.budget" class="space-y-2 mb-4">
                            <div class="flex justify-between py-2 border-b border-gray-100"><span class="text-sm text-gray-500">Budget</span><span class="text-sm font-semibold" x-text="selectedMilestone ? formatCurrency(selectedMilestone.budget) : ''"></span></div>
                            <div class="flex justify-between py-2 border-b border-gray-100"><span class="text-sm text-gray-500">Revenue</span><span class="text-sm font-semibold text-emerald-600" x-text="selectedMilestone ? formatCurrency(selectedMilestone.attributedRevenue || 0) : ''"></span></div>
                            <div class="flex justify-between py-2 border-b border-gray-100"><span class="text-sm text-gray-500">CAC</span><span class="text-sm font-semibold" x-text="selectedMilestone ? (selectedMilestone.cac || 0) + ' RON' : ''"></span></div>
                            <div class="flex justify-between py-2"><span class="text-sm text-gray-500">ROI</span><span class="text-sm font-bold" :class="selectedMilestone && selectedMilestone.roi >= 0 ? 'text-emerald-600' : 'text-red-600'" x-text="selectedMilestone ? ((selectedMilestone.roi || 0) >= 0 ? '+' : '') + (selectedMilestone.roi || 0) + '%' : ''"></span></div>
                        </div>
                        <div x-show="selectedMilestone && selectedMilestone.targeting" class="mb-4"><div class="text-xs text-gray-500 uppercase mb-1">Targeting</div><div class="text-sm text-gray-700" x-text="selectedMilestone ? selectedMilestone.targeting : ''"></div></div>
                        <div x-show="selectedMilestone && selectedMilestone.impact" class="p-3 bg-emerald-50 rounded-xl flex items-center gap-2 text-emerald-700"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg><span class="text-sm font-medium" x-text="selectedMilestone ? selectedMilestone.impact : ''"></span></div>
                    </div>
                    <div class="p-6 border-t border-gray-100 flex justify-end"><button @click="milestoneDetailModal = false" class="px-5 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-xl">Close</button></div>
                </div>
            </div>
        </div>

        <!-- Globe Modal -->
        <div x-show="globeModal" x-transition class="fixed inset-0 z-50">
            <div class="fixed inset-0 bg-black/80 backdrop-blur-sm" @click="closeGlobeModal()"></div>
            <div style="position:fixed;top:16px;left:16px;width:calc(100vw - 32px);height:calc(100vh - 32px);background:#f8fafc;border-radius:24px;overflow:hidden;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);" @click.stop>
                <!-- Map fills entire container -->
                <div id="globeMap" style="position:absolute;top:0;left:0;width:100%;height:100%;"></div>
                
                <!-- Overlay: Header -->
                <div style="position:absolute;top:0;left:0;right:0;padding:24px;background:linear-gradient(to bottom, #f8fafc, #f8fafc80, transparent);z-index:10;pointer-events:none;">
                    <div class="flex items-center justify-between pointer-events-auto">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-slate-800 flex items-center justify-center"><svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                            <div><h2 class="text-xl font-bold text-slate-800">Live Visitors</h2><p class="text-sm text-slate-500">Real-time global activity</p></div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-3 px-4 py-2 bg-white rounded-xl shadow-sm border border-slate-200">
                                <span class="relative flex h-3 w-3"><span class="pulse-ring absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span></span>
                                <span class="text-lg font-bold text-slate-800" x-text="liveVisitors"></span>
                                <span class="text-sm text-slate-500">online now</span>
                            </div>
                            <button @click="closeGlobeModal()" class="p-3 bg-white hover:bg-slate-100 rounded-xl shadow-sm border border-slate-200 transition-colors"><svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                        </div>
                    </div>
                </div>
                
                <!-- Overlay: Left Panel -->
                <div style="position:absolute;bottom:24px;left:24px;width:320px;background:rgba(255,255,255,0.95);backdrop-filter:blur(12px);border-radius:16px;border:1px solid rgba(0,0,0,0.1);overflow:hidden;z-index:10;box-shadow:0 10px 40px rgba(0,0,0,0.1);">
                    <div class="p-4 border-b border-slate-200"><div class="flex items-center justify-between"><span class="text-sm font-medium text-slate-800">Live Activity</span><span class="text-xs text-slate-400">Last 5 minutes</span></div></div>
                    <div class="p-2 max-h-64 overflow-y-auto">
                        <template x-for="(a, i) in liveActivities" :key="i">
                            <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-50 transition-colors">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-lg" x-text="a.flag"></div>
                                <div class="flex-1 min-w-0"><div class="text-sm text-slate-800 truncate" x-text="a.action"></div><div class="text-xs text-slate-400" x-text="a.city + ', ' + a.country"></div></div>
                                <div class="text-xs text-slate-300" x-text="a.time"></div>
                            </div>
                        </template>
                    </div>
                </div>
                <div style="position:absolute;bottom:24px;right:24px;width:256px;background:rgba(255,255,255,0.95);backdrop-filter:blur(12px);border-radius:16px;border:1px solid rgba(0,0,0,0.1);padding:16px;z-index:10;box-shadow:0 10px 40px rgba(0,0,0,0.1);">
                    <div class="text-sm font-medium text-slate-800 mb-3">Top Locations</div>
                    <div class="space-y-2">
                        <template x-for="l in liveLocationStats.slice(0, 5)" :key="l.city">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2"><span x-text="l.flag"></span><span class="text-sm text-slate-600" x-text="l.city"></span></div>
                                <div class="flex items-center gap-2"><div class="w-16 h-1.5 bg-slate-200 rounded-full overflow-hidden"><div class="h-full bg-emerald-500 rounded-full" :style="'width:' + l.percent + '%'"></div></div><span class="text-xs text-slate-400 w-6" x-text="l.count"></span></div>
                            </div>
                        </template>
                    </div>
                </div>
            </div><!-- close modal container -->
        </div><!-- close modal wrapper -->
    </div>

    <script>
        function eventDashboard() {
            return {
                eventMode: 'live',
                period: '30d',
                eventDropdown: false,
                liveVisitors: 47,
                milestoneModal: false,
                milestoneDetailModal: false,
                selectedMilestone: null,
                buyerModal: false,
                selectedBuyer: null,
                globeModal: false,
                selectedEvent: null,
                
                chartMetrics: [{key:'revenue',label:'Revenue',color:'#8b5cf6',active:true},{key:'tickets',label:'Tickets',color:'#06b6d4',active:true},{key:'visits',label:'Visits',color:'#f59e0b',active:false}],
                
                liveEvents: [
                    {id:1,name:'Untold Festival 2026',date:'7-10 Aug 2026',venue:'Cluj Arena',image:'https://images.unsplash.com/photo-1533174072545-7a4b6ad7a6c3?w=100&h=100&fit=crop',revenue:2847500,revenueTarget:5000000,revenueChange:23.5,ticketsSold:45230,capacity:90000,ticketsToday:234,totalVisits:485000,uniqueVisitors:312000,conversionRate:4.2,daysUntil:213,status:'On Sale',ticketTypes:[{name:'General',price:599,sold:28500,revenue:1706650,color:'#3b82f6',conversionRate:4.8,trend:12},{name:'VIP',price:1299,sold:8200,revenue:651800,color:'#8b5cf6',conversionRate:3.2,trend:-5},{name:'Early Bird',price:449,sold:5000,revenue:224500,color:'#10b981',conversionRate:6.1,trend:0},{name:'Student',price:399,sold:2800,revenue:111720,color:'#f59e0b',conversionRate:5.5,trend:18},{name:'Group',price:499,sold:730,revenue:152830,color:'#ec4899',conversionRate:2.8,trend:8}]},
                    {id:2,name:'Electric Castle 2026',date:'15-19 Jul 2026',venue:'BonÈ›ida',image:'https://images.unsplash.com/photo-1470229722913-7c0e2dbbafd3?w=100&h=100&fit=crop',revenue:1245000,revenueTarget:3000000,revenueChange:18.2,ticketsSold:22100,capacity:50000,ticketsToday:156,totalVisits:234000,uniqueVisitors:156000,conversionRate:3.8,daysUntil:189,status:'On Sale',ticketTypes:[{name:'General',price:499,sold:14200,revenue:708580,color:'#3b82f6',conversionRate:4.2,trend:8},{name:'VIP',price:999,sold:4100,revenue:409590,color:'#8b5cf6',conversionRate:2.9,trend:-3},{name:'Camping',price:299,sold:3800,revenue:126830,color:'#10b981',conversionRate:5.1,trend:15}]}
                ],
                pastEvents: [{id:101,name:'Neversea 2025',date:'3-6 Jul 2025',venue:'ConstanÈ›a Beach',image:'https://images.unsplash.com/photo-1514525253161-7a46d19cd819?w=100&h=100&fit=crop',revenue:3456000,revenueTarget:3500000,revenueChange:98.7,ticketsSold:38500,capacity:40000,ticketsToday:0,totalVisits:567000,uniqueVisitors:389000,conversionRate:4.1,daysUntil:0,status:'Completed',ticketTypes:[{name:'General',price:449,sold:25200,revenue:1131480,color:'#3b82f6',conversionRate:4.5,trend:0},{name:'VIP',price:899,sold:8100,revenue:728190,color:'#8b5cf6',conversionRate:3.1,trend:0},{name:'Premium',price:649,sold:5200,revenue:337480,color:'#ec4899',conversionRate:3.8,trend:0}]}],
                
                trafficSources: [{name:'Facebook Ads',icon:'ðŸ“˜',visitors:45200,percent:36,revenue:845000,conversions:1890,color:'#1877f2'},{name:'Google Ads',icon:'ðŸ”',visitors:28500,percent:23,revenue:523000,conversions:1120,color:'#ea4335'},{name:'Instagram',icon:'ðŸ“¸',visitors:22100,percent:18,revenue:412000,conversions:890,color:'#e4405f'},{name:'Direct',icon:'ðŸ”—',visitors:15800,percent:13,revenue:567000,conversions:1230,color:'#6b7280'},{name:'Organic',icon:'ðŸŒ±',visitors:12400,percent:10,revenue:298000,conversions:650,color:'#22c55e'}],
                topLocations: [{city:'BucureÈ™ti',country:'RomÃ¢nia',flag:'ðŸ‡·ðŸ‡´',tickets:12450,revenue:745000},{city:'Cluj-Napoca',country:'RomÃ¢nia',flag:'ðŸ‡·ðŸ‡´',tickets:8920,revenue:534000},{city:'TimiÈ™oara',country:'RomÃ¢nia',flag:'ðŸ‡·ðŸ‡´',tickets:4560,revenue:273000},{city:'IaÈ™i',country:'RomÃ¢nia',flag:'ðŸ‡·ðŸ‡´',tickets:3200,revenue:192000},{city:'Budapest',country:'Hungary',flag:'ðŸ‡­ðŸ‡º',tickets:2890,revenue:173000},{city:'Vienna',country:'Austria',flag:'ðŸ‡¦ðŸ‡¹',tickets:1560,revenue:156000}],
                
                recentSales: [
                    {id:1,name:'Andrei P.',initials:'AP',email:'a***@gmail.com',date:'Jan 8, 2026 14:36',quantity:4,ticketType:'VIP',source:'Facebook',amount:5196,paymentMethod:'Visa â€¢â€¢â€¢â€¢ 4242',paymentIcon:'ðŸ’³',isReturning:true,previousPurchases:3,lifetimeValue:8945,flag:'ðŸ‡·ðŸ‡´',location:'BucureÈ™ti',device:'Desktop',browser:'Chrome 120',timeToPurchase:'4m 23s',journey:[{type:'found',source:'Facebook Ad',time:'14:32'},{type:'pageview',page:'/untold-2026',time:'14:32'},{type:'event',name:'view_lineup',time:'14:33'},{type:'event',name:'select_tickets',params:'VIP x4',time:'14:34'},{type:'pageview',page:'/checkout',time:'14:35'},{type:'purchase',amount:5196,time:'14:36'}]},
                    {id:2,name:'Maria D.',initials:'MD',email:'m***@yahoo.com',date:'Jan 8, 2026 14:33',quantity:2,ticketType:'General',source:'Google',amount:1198,paymentMethod:'Mastercard â€¢â€¢â€¢â€¢ 8888',paymentIcon:'ðŸ’³',isReturning:false,flag:'ðŸ‡·ðŸ‡´',location:'Cluj-Napoca',device:'iPhone 14',browser:'Safari 17',timeToPurchase:'8m 12s',journey:[{type:'found',source:'Google Search',time:'14:25'},{type:'pageview',page:'/untold-2026',time:'14:25'},{type:'event',name:'view_pricing',time:'14:28'},{type:'event',name:'add_to_cart',params:'General x2',time:'14:30'},{type:'pageview',page:'/checkout',time:'14:31'},{type:'purchase',amount:1198,time:'14:33'}]},
                    {id:3,name:'Ion V.',initials:'IV',email:'i***@outlook.com',date:'Jan 8, 2026 14:21',quantity:1,ticketType:'VIP',source:'Direct',amount:1299,paymentMethod:'Apple Pay',paymentIcon:'ðŸŽ',isReturning:true,previousPurchases:5,lifetimeValue:12450,flag:'ðŸ‡·ðŸ‡´',location:'TimiÈ™oara',device:'MacBook Pro',browser:'Safari 17',timeToPurchase:'2m 45s',journey:[{type:'found',source:'Direct',time:'14:18'},{type:'pageview',page:'/untold-2026',time:'14:18'},{type:'event',name:'select_tickets',params:'VIP x1',time:'14:19'},{type:'pageview',page:'/checkout',time:'14:20'},{type:'purchase',amount:1299,time:'14:21'}]},
                    {id:4,name:'Elena R.',initials:'ER',email:'e***@gmail.com',date:'Jan 8, 2026 14:11',quantity:3,ticketType:'General',source:'Instagram',amount:1797,paymentMethod:'Google Pay',paymentIcon:'ðŸ”µ',isReturning:false,flag:'ðŸ‡·ðŸ‡´',location:'IaÈ™i',device:'Samsung S23',browser:'Chrome Mobile',timeToPurchase:'15m 34s',journey:[{type:'found',source:'Instagram Story',time:'13:55'},{type:'pageview',page:'/untold-2026',time:'13:56'},{type:'event',name:'view_lineup',time:'13:58'},{type:'event',name:'view_faq',time:'14:02'},{type:'event',name:'view_pricing',time:'14:05'},{type:'event',name:'select_tickets',params:'General x3',time:'14:08'},{type:'pageview',page:'/checkout',time:'14:09'},{type:'purchase',amount:1797,time:'14:11'}]},
                    {id:5,name:'Radu M.',initials:'RM',email:'r***@gmail.com',date:'Jan 8, 2026 13:49',quantity:5,ticketType:'Group',source:'Facebook',amount:2495,paymentMethod:'Bank Transfer',paymentIcon:'ðŸ¦',isReturning:false,flag:'ðŸ‡·ðŸ‡´',location:'BraÈ™ov',device:'Desktop',browser:'Firefox',timeToPurchase:'6m 18s',journey:[{type:'found',source:'Facebook Ad',time:'13:42'},{type:'pageview',page:'/untold-2026',time:'13:43'},{type:'event',name:'view_pricing',time:'13:44'},{type:'event',name:'view_group_offers',time:'13:46'},{type:'event',name:'select_tickets',params:'Group x5',time:'13:47'},{type:'pageview',page:'/checkout',time:'13:48'},{type:'purchase',amount:2495,time:'13:49'}]}
                ],
                
                milestones: [
                    {id:1,type:'campaign_fb',title:'Facebook Awareness',description:'Targeting music lovers 18-35 in Romania',startDate:'Jan 5, 2026',endDate:'Jan 20, 2026',budget:15000,targeting:'18-35, Music, Romania',impact:'+45% traffic',attributedRevenue:89000,cac:28,roi:493,isActive:true},
                    {id:2,type:'campaign_google',title:'Google Search Ads',description:'Festival + concert keywords',startDate:'Jan 3, 2026',endDate:'Jan 15, 2026',budget:8500,targeting:'Festival Romania, Concert Cluj',attributedRevenue:42000,cac:35,roi:394,isActive:true},
                    {id:3,type:'email',title:'Early Bird Newsletter',description:'Sent to 45,000 subscribers',startDate:'Dec 28, 2025',impact:'+234 sales in 24h'},
                    {id:4,type:'price',title:'Early Bird Ended',description:'Prices increased by 25%',startDate:'Dec 20, 2025'},
                    {id:5,type:'announcement',title:'Headliner Announced',description:'Martin Garrix confirmed',startDate:'Dec 15, 2025',impact:'+89% social mentions'}
                ],
                
                newMilestone: {type:'campaign_fb',title:'',startDate:'',endDate:'',budget:null,targeting:'',description:''},
                milestoneTypes: [{value:'campaign_fb',label:'Facebook',icon:'ðŸ“˜'},{value:'campaign_google',label:'Google',icon:'ðŸ”'},{value:'campaign_tiktok',label:'TikTok',icon:'ðŸŽµ'},{value:'email',label:'Email',icon:'ðŸ“§'},{value:'price',label:'Price',icon:'ðŸ’°'},{value:'announcement',label:'Announce',icon:'ðŸ“¢'},{value:'press',label:'Press',icon:'ðŸ“°'},{value:'campaign_other',label:'Other',icon:'ðŸ“£'},{value:'custom',label:'Custom',icon:'ðŸ“Œ'}],
                
                liveActivities: [
                    {flag:'ðŸ‡·ðŸ‡´',action:'Viewing checkout page',city:'BucureÈ™ti',country:'Romania',time:'now'},
                    {flag:'ðŸ‡·ðŸ‡´',action:'Added 2x VIP to cart',city:'Cluj-Napoca',country:'Romania',time:'12s'},
                    {flag:'ðŸ‡­ðŸ‡º',action:'Viewing event page',city:'Budapest',country:'Hungary',time:'28s'},
                    {flag:'ðŸ‡·ðŸ‡´',action:'Completed purchase',city:'TimiÈ™oara',country:'Romania',time:'45s'},
                    {flag:'ðŸ‡¦ðŸ‡¹',action:'Viewing pricing',city:'Vienna',country:'Austria',time:'1m'},
                    {flag:'ðŸ‡·ðŸ‡´',action:'Selected General tickets',city:'IaÈ™i',country:'Romania',time:'1m'},
                    {flag:'ðŸ‡©ðŸ‡ª',action:'Viewing lineup',city:'Berlin',country:'Germany',time:'2m'},
                    {flag:'ðŸ‡·ðŸ‡´',action:'Viewing FAQ',city:'BraÈ™ov',country:'Romania',time:'2m'}
                ],
                liveLocationStats: [{city:'BucureÈ™ti',flag:'ðŸ‡·ðŸ‡´',count:18,percent:38},{city:'Cluj-Napoca',flag:'ðŸ‡·ðŸ‡´',count:9,percent:19},{city:'TimiÈ™oara',flag:'ðŸ‡·ðŸ‡´',count:6,percent:13},{city:'Budapest',flag:'ðŸ‡­ðŸ‡º',count:5,percent:11},{city:'IaÈ™i',flag:'ðŸ‡·ðŸ‡´',count:4,percent:9},{city:'Vienna',flag:'ðŸ‡¦ðŸ‡¹',count:3,percent:6},{city:'Berlin',flag:'ðŸ‡©ðŸ‡ª',count:2,percent:4}],
                
                globeMarkers: [
                    {lng:26.1025,lat:44.4268,city:'BucureÈ™ti',country:'Romania',visitors:18,type:'live',name:'AND*** P.',avatar:'https://api.dicebear.com/7.x/avataaars/svg?seed=1',device:'Desktop',browser:'Chrome',page:'/untold-2026',sessionTime:'4 min 23 sec'},
                    {lng:23.6236,lat:46.7712,city:'Cluj-Napoca',country:'Romania',visitors:9,type:'conversion',name:'MAR** D.',avatar:'https://api.dicebear.com/7.x/avataaars/svg?seed=3',device:'Mobile',browser:'Safari',page:'/checkout',sessionTime:'8 min 12 sec'},
                    {lng:21.2087,lat:45.7489,city:'TimiÈ™oara',country:'Romania',visitors:6,type:'visitor',name:'ION** V.',avatar:'https://api.dicebear.com/7.x/avataaars/svg?seed=5',device:'Desktop',browser:'Firefox',page:'/lineup',sessionTime:'2 min 45 sec'},
                    {lng:19.0402,lat:47.4979,city:'Budapest',country:'Hungary',visitors:5,type:'live',name:'PET** K.',avatar:'https://api.dicebear.com/7.x/avataaars/svg?seed=8',device:'Desktop',browser:'Chrome',page:'/tickets',sessionTime:'5 min 18 sec'},
                    {lng:27.6014,lat:47.1585,city:'IaÈ™i',country:'Romania',visitors:4,type:'visitor',name:'ELE** R.',avatar:'https://api.dicebear.com/7.x/avataaars/svg?seed=11',device:'Mobile',browser:'Chrome',page:'/faq',sessionTime:'1 min 34 sec'},
                    {lng:16.3738,lat:48.2082,city:'Vienna',country:'Austria',visitors:3,type:'visitor',name:'HAN** M.',avatar:'https://api.dicebear.com/7.x/avataaars/svg?seed=12',device:'Desktop',browser:'Safari',page:'/pricing',sessionTime:'3 min 22 sec'},
                    {lng:13.4050,lat:52.5200,city:'Berlin',country:'Germany',visitors:2,type:'live',name:'MAX** S.',avatar:'https://api.dicebear.com/7.x/avataaars/svg?seed=15',device:'Desktop',browser:'Chrome',page:'/untold-2026',sessionTime:'6 min 45 sec'},
                    {lng:25.5887,lat:45.6427,city:'BraÈ™ov',country:'Romania',visitors:2,type:'visitor',name:'RAD** M.',avatar:'https://api.dicebear.com/7.x/avataaars/svg?seed=17',device:'Mobile',browser:'Chrome',page:'/',sessionTime:'2 min 11 sec'}
                ],
                
                get currentEventsList() { return this.eventMode === 'live' ? this.liveEvents : this.pastEvents; },
                
                getSelectedEvent() { return this.selectedEvent || this.liveEvents[0]; },
                
                init() {
                    this.selectedEvent = this.liveEvents[0];
                    this.$nextTick(() => this.initCharts());
                    setInterval(() => { this.liveVisitors = Math.max(20, this.liveVisitors + Math.floor(Math.random() * 11) - 5); }, 5000);
                },
                
                switchToLive() { this.eventMode = 'live'; this.selectedEvent = this.liveEvents[0]; this.$nextTick(() => this.initCharts()); },
                switchToPast() { this.eventMode = 'past'; this.selectedEvent = this.pastEvents[0]; this.$nextTick(() => this.initCharts()); },
                selectEvent(e) { this.selectedEvent = e; this.$nextTick(() => this.initCharts()); },
                selectPeriod(p) { this.period = p; this.$nextTick(() => this.initCharts()); },
                toggleMetric(k) { const m = this.chartMetrics.find(x => x.key === k); if(m) { if(this.chartMetrics.filter(x => x.active).length === 1 && m.active) return; m.active = !m.active; this.$nextTick(() => this.initCharts()); } },
                
                formatCurrency(v) { if(!v) return '0 RON'; if(v >= 1000000) return (v/1000000).toFixed(2)+'M RON'; if(v >= 1000) return Math.round(v/1000)+'K RON'; return v+' RON'; },
                isAdCampaign(t) { return ['campaign_fb','campaign_google','campaign_tiktok','campaign_other'].includes(t); },
                getAdCampaigns() { return this.milestones.filter(m => this.isAdCampaign(m.type) && m.budget); },
                getTotalAdSpend() { return this.getAdCampaigns().reduce((s,c) => s + (c.budget||0), 0); },
                getMilestoneIcon(t) { return {campaign_fb:'ðŸ“˜',campaign_google:'ðŸ”',campaign_tiktok:'ðŸŽµ',campaign_other:'ðŸ“£',email:'ðŸ“§',price:'ðŸ’°',announcement:'ðŸ“¢',press:'ðŸ“°',custom:'ðŸ“Œ'}[t]||'ðŸ“Œ'; },
                getMilestoneIconClass(t) { return {campaign_fb:'bg-blue-100',campaign_google:'bg-red-100',campaign_tiktok:'bg-pink-100',email:'bg-amber-100',price:'bg-emerald-100',announcement:'bg-purple-100'}[t]||'bg-gray-100'; },
                getSourceClass(s) { return {Facebook:'bg-blue-100 text-blue-700',Google:'bg-red-100 text-red-700',Instagram:'bg-pink-100 text-pink-700',Direct:'bg-gray-100 text-gray-700',TikTok:'bg-purple-100 text-purple-700'}[s]||'bg-gray-100 text-gray-700'; },
                
                addMilestone() { if(!this.newMilestone.title || !this.newMilestone.startDate) return; const fmt = d => new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}); const m = {id:Date.now(),type:this.newMilestone.type,title:this.newMilestone.title,description:this.newMilestone.description||(this.newMilestone.targeting?'Targeting: '+this.newMilestone.targeting:''),startDate:fmt(this.newMilestone.startDate),endDate:this.newMilestone.endDate?fmt(this.newMilestone.endDate):null,budget:this.newMilestone.budget?Number(this.newMilestone.budget):null,targeting:this.newMilestone.targeting,isActive:this.newMilestone.endDate?new Date(this.newMilestone.endDate)>new Date():true}; if(this.isAdCampaign(m.type)&&m.budget){m.attributedRevenue=Math.round(m.budget*(2+Math.random()*4));m.cac=Math.round(m.budget/(m.attributedRevenue/500));m.roi=Math.round(((m.attributedRevenue-m.budget)/m.budget)*100);} this.milestones.unshift(m); this.newMilestone={type:'campaign_fb',title:'',startDate:'',endDate:'',budget:null,targeting:'',description:''}; this.milestoneModal=false; },
                showMilestoneDetail(m) { this.selectedMilestone = m; this.milestoneDetailModal = true; },
                showBuyerJourney(s) { this.selectedBuyer = s; this.buyerModal = true; },
                formatJourneyEvent(e) { if(e.type==='found') return 'Found via <span class="font-medium text-purple-600">'+e.source+'</span>'; if(e.type==='pageview') return 'Viewed <span class="font-mono text-blue-600">'+e.page+'</span>'; if(e.type==='purchase') return '<span class="font-semibold text-emerald-600">Completed purchase</span>'; if(e.type==='event') return '<span class="text-amber-600">'+e.name+'</span>'+(e.params?' <span class="text-gray-400">('+e.params+')</span>':''); return e.name; },
                
                openGlobeModal() { 
                    this.globeModal = true; 
                    const self = this;
                    // Wait longer for modal DOM to be ready
                    setTimeout(function() {
                        self.initGlobe();
                    }, 800);
                },
                closeGlobeModal() { 
                    this.globeModal = false; 
                    if(window.globeMap) { 
                        try { window.globeMap.remove(); } catch(e) {}
                        window.globeMap = null; 
                    }
                },
                
                initGlobe() {
                    const self = this;
                    
                    if(typeof L === 'undefined') {
                        setTimeout(function() { self.initGlobe(); }, 300);
                        return;
                    }
                    
                    const container = document.getElementById('globeMap');
                    if(!container) {
                        setTimeout(function() { self.initGlobe(); }, 300);
                        return;
                    }
                    
                    const rect = container.getBoundingClientRect();
                    if(rect.width < 100 || rect.height < 100) {
                        setTimeout(function() { self.initGlobe(); }, 300);
                        return;
                    }
                    
                    // If valid map exists, just refresh
                    if(window.globeMap && typeof window.globeMap.invalidateSize === 'function') {
                        window.globeMap.invalidateSize();
                        return;
                    }
                    
                    console.log('Creating map, container:', rect.width, 'x', rect.height);
                    
                    try {
                    const map = L.map(container, {
                        center: [46, 20],
                        zoom: 5,
                        zoomControl: false,
                        attributionControl: false
                    });
                    
                    // Add light tile layer (Carto Voyager - labels visible)
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                        subdomains: 'abcd',
                        maxZoom: 19
                    }).addTo(map);
                    
                    // Add zoom control to bottom right
                    L.control.zoom({ position: 'bottomright' }).addTo(map);
                    
                    window.globeMap = map;
                    
                    // Force invalidateSize
                    map.invalidateSize();
                    setTimeout(function() {
                        map.invalidateSize();
                    }, 100);
                    
                    // Add markers after a short delay
                    setTimeout(function() {
                        map.invalidateSize();
                        
                        self.globeMarkers.forEach(function(loc) {
                            const borderColor = loc.type === 'live' ? '#10b981' : loc.type === 'conversion' ? '#f97316' : '#3b82f6';
                            const pulseStyle = loc.type === 'live' ? 'animation:avatarPulse 2s ease-in-out infinite;' : '';
                            
                            // Create custom icon with avatar
                            const iconHtml = '<div style="width:44px;height:44px;border-radius:50%;border:3px solid '+borderColor+';overflow:hidden;cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,0.3);background:#fff;'+pulseStyle+'"><img src="'+loc.avatar+'" style="width:100%;height:100%;object-fit:cover;"/></div>';
                            
                            const customIcon = L.divIcon({
                                html: iconHtml,
                                className: 'custom-avatar-marker',
                                iconSize: [44, 44],
                                iconAnchor: [22, 22],
                                popupAnchor: [0, -25]
                            });
                            
                            const popupHTML = '<div style="font-family:Inter,-apple-system,sans-serif;width:250px;margin:-14px -20px -15px -20px;">'+
                                '<div style="padding:12px;border-bottom:1px solid #e5e7eb;">'+
                                    '<div style="display:flex;align-items:center;gap:10px;">'+
                                        '<img src="'+loc.avatar+'" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid '+borderColor+';"/>'+
                                        '<div style="flex:1;">'+
                                            '<div style="font-weight:600;font-size:13px;color:#111827;">'+loc.name+'</div>'+
                                            '<div style="font-size:11px;color:#6b7280;">ðŸ“ '+loc.city+', '+loc.country+'</div>'+
                                        '</div>'+
                                        '<div style="padding:3px 6px;border-radius:4px;font-size:9px;font-weight:600;'+(loc.type === 'live' ? 'background:#dcfce7;color:#16a34a;' : loc.type === 'conversion' ? 'background:#ffedd5;color:#ea580c;' : 'background:#dbeafe;color:#2563eb;')+'">'+(loc.type === 'live' ? 'â— LIVE' : loc.type === 'conversion' ? 'âœ“ BOUGHT' : 'VIEW')+'</div>'+
                                    '</div>'+
                                '</div>'+
                                '<div style="padding:12px;font-size:11px;">'+
                                    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">'+
                                        '<div><div style="color:#9ca3af;font-size:9px;margin-bottom:1px;">Device</div><div style="color:#111827;font-weight:500;">'+(loc.device === 'Mobile' ? 'ðŸ“±' : 'ðŸ’»')+' '+loc.device+'</div></div>'+
                                        '<div><div style="color:#9ca3af;font-size:9px;margin-bottom:1px;">Browser</div><div style="color:#111827;font-weight:500;">ðŸŒ '+loc.browser+'</div></div>'+
                                        '<div><div style="color:#9ca3af;font-size:9px;margin-bottom:1px;">Page</div><div style="color:#111827;font-weight:500;font-family:monospace;font-size:10px;">'+loc.page+'</div></div>'+
                                        '<div><div style="color:#9ca3af;font-size:9px;margin-bottom:1px;">Session</div><div style="color:#111827;font-weight:500;">'+loc.sessionTime+'</div></div>'+
                                    '</div>'+
                                    '<div style="margin-top:10px;padding:8px;background:#f8fafc;border-radius:6px;display:flex;align-items:center;justify-content:space-between;">'+
                                        '<span style="font-size:10px;color:#64748b;">Visitors from '+loc.city+'</span>'+
                                        '<span style="font-size:14px;font-weight:700;color:#7c3aed;">'+loc.visitors+'</span>'+
                                    '</div>'+
                                '</div>'+
                            '</div>';
                            
                            L.marker([loc.lat, loc.lng], { icon: customIcon })
                                .addTo(map)
                                .bindPopup(popupHTML, { maxWidth: 280 });
                        });
                    }, 300);
                    
                    } catch(e) {
                        console.error('Error initializing map:', e);
                    }
                },
                
                initCharts() {
                    const el = document.querySelector("#mainChart");
                    if(!el) return;
                    el.innerHTML = '';
                    const days = this.period==='7d'?7:this.period==='30d'?30:60;
                    const data = [];
                    const now = new Date();
                    for(let i=days-1;i>=0;i--){ const d=new Date(now);d.setDate(d.getDate()-i);const w=[0,6].includes(d.getDay())?1.4:1;data.push({date:d.toLocaleDateString('en-US',{day:'2-digit',month:'short'}),fullDate:d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'}),rawDate:new Date(d),revenue:Math.floor((Math.random()*80000+30000)*w),tickets:Math.floor((Math.random()*150+50)*w),visits:Math.floor((Math.random()*8000+3000)*w)}); }
                    const series=[],colors=[],yaxis=[];
                    const self = this;
                    this.chartMetrics.forEach(function(m,i){ if(m.active){series.push({name:m.label,type:m.key==='tickets'?'column':'area',data:data.map(function(d){return d[m.key];})});colors.push(m.color);yaxis.push({opposite:i>0,title:{text:m.label,style:{color:m.color,fontSize:'11px'}},labels:{style:{colors:'#9ca3af',fontSize:'10px'},formatter:function(v){return v>=1000?(v/1000).toFixed(0)+'K':v;}}});} });
                    
                    // Build milestone annotations
                    const annotations = [];
                    const startDate = data[0].rawDate;
                    const endDate = data[data.length-1].rawDate;
                    this.milestones.forEach(function(m) {
                        const mDate = new Date(m.startDate);
                        if(mDate >= startDate && mDate <= endDate) {
                            const dateStr = mDate.toLocaleDateString('en-US',{day:'2-digit',month:'short'});
                            const idx = data.findIndex(function(d){ return d.date === dateStr; });
                            if(idx >= 0) {
                                annotations.push({
                                    x: dateStr,
                                    borderColor: m.budget ? '#8b5cf6' : '#f59e0b',
                                    strokeDashArray: 0,
                                    label: {
                                        borderColor: m.budget ? '#8b5cf6' : '#f59e0b',
                                        style: { color: '#fff', background: m.budget ? '#8b5cf6' : '#f59e0b', fontSize: '10px', fontWeight: 600, padding: { left: 6, right: 6, top: 3, bottom: 3 } },
                                        text: self.getMilestoneIcon(m.type) + ' ' + m.title.substring(0,15) + (m.title.length > 15 ? '...' : ''),
                                        position: 'top'
                                    }
                                });
                            }
                        }
                    });
                    
                    new ApexCharts(el,{chart:{type:'line',height:300,toolbar:{show:false},fontFamily:'Inter',animations:{enabled:true,speed:400}},series:series,colors:colors,stroke:{curve:'smooth',width:series.map(function(s){return s.type==='column'?0:2.5;})},fill:{type:series.map(function(s){return s.type==='column'?'solid':'gradient';}),gradient:{shadeIntensity:1,opacityFrom:0.4,opacityTo:0.1}},plotOptions:{bar:{borderRadius:4,columnWidth:'40%'}},dataLabels:{enabled:false},xaxis:{categories:data.map(function(d){return d.date;}),labels:{style:{colors:'#9ca3af',fontSize:'10px'}},axisBorder:{show:false},axisTicks:{show:false}},yaxis:yaxis,grid:{borderColor:'#f1f5f9'},legend:{show:false},annotations:{xaxis:annotations},tooltip:{shared:true,intersect:false,custom:function(opts){
                        const d=data[opts.dataPointIndex];
                        let h='<div style="background:#fff;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.15);padding:14px;font-size:12px;min-width:200px;"><div style="font-weight:600;color:#1f2937;margin-bottom:10px;">'+d.fullDate+'</div>';
                        self.chartMetrics.forEach(function(m){if(m.active)h+='<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;"><div style="display:flex;align-items:center;gap:6px;"><div style="width:8px;height:8px;border-radius:50%;background:'+m.color+';"></div><span style="color:#6b7280;">'+m.label+'</span></div><span style="font-weight:600;color:#1f2937;">'+(m.key==='revenue'?self.formatCurrency(d[m.key]):d[m.key].toLocaleString())+'</span></div>';});
                        // Check for milestones on this date
                        const dateStr = d.date;
                        self.milestones.forEach(function(m){
                            const mDate = new Date(m.startDate);
                            const mDateStr = mDate.toLocaleDateString('en-US',{day:'2-digit',month:'short'});
                            if(mDateStr === dateStr){
                                h+='<div style="margin-top:10px;padding-top:10px;border-top:1px solid #e5e7eb;"><div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;"><span>'+self.getMilestoneIcon(m.type)+'</span><span style="font-weight:600;color:#7c3aed;">'+m.title+'</span></div>';
                                if(m.budget) h+='<div style="font-size:11px;color:#6b7280;">Budget: '+self.formatCurrency(m.budget)+' â€¢ ROI: <span style="color:'+(m.roi>=0?'#10b981':'#ef4444')+';font-weight:600;">'+(m.roi>=0?'+':'')+m.roi+'%</span></div>';
                                else if(m.impact) h+='<div style="font-size:11px;color:#10b981;font-weight:500;">'+m.impact+'</div>';
                                else h+='<div style="font-size:11px;color:#6b7280;">'+m.description+'</div>';
                                h+='</div>';
                            }
                        });
                        return h+'</div>';
                    }}}).render();
                }
            };
        }
    </script>
</body>
</html>

const CartPage={timerInterval:null,endTime:null,appliedPromo:null,discount:0,taxes:[],async init(){await this.loadTaxes(),this.setupTimer(),this.loadExistingPromo(),this.render()},async loadTaxes(){const e=AmbiletCart.getItems();if(e.length>0&&e[0].event?.taxes?.length>0)this.taxes=e[0].event.taxes.filter(e=>!1!==e.is_active);else{try{if("undefined"!=typeof AmbiletAPI){const e=await AmbiletAPI.get("/config/taxes");if(e.success&&e.data?.taxes)return void(this.taxes=e.data.taxes)}}catch(e){console.log("Using default taxes from config")}this.taxes=[]}},setupTimer(){const e=localStorage.getItem("cart_end_time");if(0===AmbiletCart.getItems().length)return localStorage.removeItem("cart_end_time"),void document.getElementById("timer-bar").classList.add("hidden");e&&parseInt(e)>Date.now()?this.endTime=parseInt(e):(this.endTime=Date.now()+9e5,localStorage.setItem("cart_end_time",this.endTime)),this.updateCountdown(),this.timerInterval=setInterval(()=>this.updateCountdown(),1e3)},warningShown:!1,updateCountdown(){const e=Math.max(0,this.endTime-Date.now()),t=Math.floor(e/6e4),s=Math.floor(e%6e4/1e3),n=document.getElementById("countdown"),i=document.getElementById("timer-bar");n.textContent=`${t.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`,e<=0?(clearInterval(this.timerInterval),n.textContent="00:00",n.classList.remove("text-warning"),n.classList.add("text-primary"),this.releaseAllSeats().then(()=>{AmbiletCart.clear(),localStorage.removeItem("cart_end_time"),this.render(),"undefined"!=typeof AmbiletNotifications&&AmbiletNotifications.warning("Timpul de rezervare a expirat. Locurile au fost eliberate.")})):e<6e4?(n.classList.remove("text-warning"),n.classList.add("text-primary"),i&&(i.classList.remove("bg-warning/10","border-warning/20"),i.classList.add("bg-red-50","border-red-200"))):e<=3e5&&!this.warningShown&&(this.warningShown=!0,n.classList.remove("text-warning"),n.classList.add("text-orange-500"),i&&i.classList.add("animate-pulse"),"undefined"!=typeof AmbiletNotifications&&AmbiletNotifications.warning("Mai ai doar 5 minute pentru a finaliza comanda! După expirare, locurile vor fi eliberate."))},async releaseAllSeats(){const e=AmbiletCart.getItems();for(const t of e)if(t.seat_uids&&t.seat_uids.length>0&&t.event_seating_id)try{console.log("[CartPage] Releasing seats for item:",t.key,t.seat_uids),await AmbiletAPI.delete("/cart/seats",{event_seating_id:t.event_seating_id,seat_uids:t.seat_uids}),console.log("[CartPage] Seats released successfully")}catch(e){console.error("[CartPage] Failed to release seats:",e)}},render(){const e=AmbiletCart.getItems();console.log("[CartPage] Cart items:",e),console.log("[CartPage] First item:",e[0]),console.log("[CartPage] Taxes from cart:",e[0]?.event?.taxes),console.log("[CartPage] CartPage.taxes:",this.taxes);const t=document.getElementById("cart-loading"),s=document.getElementById("cartPageItems"),n=document.getElementById("emptyCart"),i=document.getElementById("summary-section"),o=document.getElementById("promo-section"),a=document.getElementById("timer-bar");if(t.classList.add("hidden"),0===e.length)return s.classList.add("hidden"),i.classList.add("hidden"),o.classList.add("hidden"),a.classList.add("hidden"),void n.classList.remove("hidden");n.classList.add("hidden"),s.classList.remove("hidden"),i.classList.remove("hidden"),o.classList.remove("hidden"),a.classList.remove("hidden");try{console.log("[CartPage] About to render items, count:",e.length),console.log("[CartPage] Container element:",s),console.log("[CartPage] Container classList before:",s.className);const t=e.map((e,t)=>(console.log("[CartPage] Rendering item",t,":",e),this.renderCartItem(e,t))).join("");console.log("[CartPage] Generated HTML length:",t.length),console.log("[CartPage] First 500 chars of HTML:",t.substring(0,500)),s.innerHTML=t,console.log("[CartPage] Items rendered to container"),console.log("[CartPage] Container classList after:",s.className),console.log("[CartPage] Container children count:",s.children.length),console.log("[CartPage] Container display style:",window.getComputedStyle(s).display),this.updateSummary()}catch(e){console.error("[CartPage] Error rendering items:",e)}},renderCartItem(e,t){const s=e.key||t,n=getStorageUrl(e.event?.image||e.event_image),i=e.event?.title||e.event_title||"Eveniment",o=e.event?.date||e.event_date||"",a=e.event?.venue?.name||e.event?.venue||e.venue_name||"",r=e.ticketType?.name||e.ticket_type_name||"Bilet",l=e.ticketType?.description||"",d=e.ticketType?.price||e.price||0,c=e.ticketType?.originalPrice||e.original_price||0,m=e.quantity||1,u=e.seats||[],p=u.length>0||e.seat_uids&&e.seat_uids.length>0,g=e.event?.slug||"",v=AmbiletCart.calculateItemCommission(e),h=v.mode||"included",x=c&&c>d,f=x?Math.round(100*(1-d/c)):0,b=o?AmbiletUtils.formatDate(o,"medium"):"";let y=0;"added_on_top"===h&&(y=v.amount);const C=d+y;let w='<p class="pb-2 mb-3 text-sm font-semibold border-b border-white/20">Detalii preț bilet '+r+'</p><div class="space-y-2 text-xs"><div class="flex justify-between"><span class="text-white/90">Preț bilet:</span><span>'+d.toFixed(2)+" lei</span></div>";if("added_on_top"===h&&y>0){let e="Taxe procesare";"percentage"===v.type?e+=" ("+v.rate+"%)":"fixed"===v.type?e+=" (fix)":"both"===v.type&&(e+=" ("+v.rate+"% + "+v.fixed.toFixed(2)+" lei)"),w+='<div class="flex justify-between"><span class="text-white/90">'+e+":</span><span>+"+y.toFixed(2)+' lei</span></div><div class="flex justify-between pt-2 mt-2 border-t border-white/20"><span class="font-semibold">Total la plată:</span><span class="font-semibold">'+C.toFixed(2)+" lei</span></div>"}return w+="</div>",'<div class="bg-white border-2 cart-item rounded-2xl border-border" data-item-key="'+s+'" data-index="'+t+'"><div class="flex gap-4 p-3"><div class="w-24 h-24 overflow-hidden rounded-xl shrink-0 mobile:w-12 mobile:h-12"><img src="'+n+'" alt="'+i+'" class="object-cover w-full h-full" loading="lazy"></div><div class="flex-1 min-w-0"><div class="flex items-center justify-between"><div class="flex-1 min-w-0"><h3 class="font-semibold truncate text-secondary">'+i+'</h3><p class="text-sm text-muted">'+b+(a?" • "+a:"")+'</p></div><button onclick="CartPage.removeItem('+t+')" class="self-start p-2 transition-colors rounded-lg text-muted hover:text-error hover:bg-red-50"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div><div class="flex items-center justify-between mt-3 mobile:hidden"><div class="relative inline-block tooltip-trigger"><div class="flex items-center gap-2"><span class="inline-flex items-center px-2 py-1 text-sm font-semibold text-secondary">'+r+(x?' <span class="discount-badge text-white text-[10px] font-bold py-0.5 px-1.5 rounded-full ml-1">-'+f+"%</span>":"")+'</span><svg class="w-4 h-4 text-muted cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>'+(l?'<p class="text-xs text-muted mt-0.5">'+l+"</p>":"")+(u.length>0?'<p class="mt-1 mr-4 text-xs text-primary"><svg class="inline w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>'+this.formatSeats(u)+"</p>":"")+'<div class="absolute left-0 z-10 p-4 mt-2 text-white shadow-xl tooltip top-full w-72 bg-secondary rounded-xl">'+w+"</div></div>"+(p?'<div class="flex items-center gap-2 ml-auto mr-8"><span class="w-8 font-semibold text-center">'+m+'</span><a href="/bilete/'+g+'" class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-semibold text-primary border border-primary/30 rounded-lg hover:bg-primary/5 transition-colors flex-none"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>Adaugă locuri</a></div>':'<div class="flex items-center gap-2 ml-auto mr-8"><button onclick="CartPage.updateQuantity('+t+', -1)" class="flex items-center justify-center w-8 h-8 border rounded-lg border-border hover:bg-surface"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg></button><span class="w-8 font-semibold text-center">'+m+'</span><button onclick="CartPage.updateQuantity('+t+', 1)" class="flex items-center justify-center w-8 h-8 border rounded-lg border-border hover:bg-surface"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg></button></div>')+'<div class="flex-none text-right">'+(x?'<div class="text-sm line-through text-muted">'+AmbiletUtils.formatCurrency(c*m)+"</div>":"")+'<div class="font-bold text-primary">'+AmbiletUtils.formatCurrency(d*m)+'</div></div></div></div></div><div class="items-center justify-between hidden px-2 pb-2 mobile:flex"><div class="relative inline-block tooltip-trigger"><div class="flex items-center gap-2"><span class="w-8 font-semibold text-center">'+m+' x </span><span class="inline-flex items-center py-1 pr-2 text-sm font-semibold text-secondary">'+r+(x?' <span class="discount-badge text-white text-[10px] font-bold py-0.5 px-1.5 rounded-full ml-1">-'+f+"%</span>":"")+'</span><svg class="w-4 h-4 text-muted cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>'+(l?'<p class="text-xs text-muted mt-0.5">'+l+"</p>":"")+(u.length>0?'<p class="mt-1 mr-4 text-xs text-primary"><svg class="inline w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>'+this.formatSeats(u)+"</p>":"")+'<div class="absolute left-0 z-10 p-4 mt-2 text-white shadow-xl tooltip top-full w-72 bg-secondary rounded-xl">'+w+'</div></div><div class="flex-none text-right"><div class="flex items-center gap-2">'+(x?'<div class="text-sm line-through text-muted">'+AmbiletUtils.formatCurrency(c*m)+"</div>":"")+'<div class="font-bold text-primary">'+AmbiletUtils.formatCurrency(d*m)+"</div></div>"+(p?'<div class="flex items-center gap-2 ml-auto"><a href="/bilete/'+g+'" class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-semibold text-primary border border-primary/30 rounded-lg hover:bg-primary/5 transition-colors flex-none"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>Adaugă locuri</a></div>':'<div class="flex items-center gap-2 ml-auto"><button onclick="CartPage.updateQuantity('+t+', -1)" class="flex items-center justify-center w-8 h-8 border rounded-lg border-border hover:bg-surface"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg></button><span class="w-8 font-semibold text-center">'+m+'</span><button onclick="CartPage.updateQuantity('+t+', 1)" class="flex items-center justify-center w-8 h-8 border rounded-lg border-border hover:bg-surface"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg></button></div>')+"</div></div></div>"},updateQuantity(e,t){const s=AmbiletCart.getItems();if(!s[e])return;let n=s[e].quantity+t;const i=s[e].ticketType?.min_per_order||s[e].min_per_order||1,o=s[e].ticketType?.max_per_order||s[e].max_per_order||s[e].max_quantity||10;t>0&&n>o?"undefined"!=typeof AmbiletNotifications&&AmbiletNotifications.warning(`Poți cumpăra maximum ${o} bilete de acest tip`):t<0&&n<i&&n>0||n<1?this.removeItem(e):(s[e].quantity=n,AmbiletCart.save(s),this.render())},async removeItem(e){const t=AmbiletCart.getItems(),s=t[e],n=document.querySelector(`[data-index="${e}"]`)||document.querySelector(`.cart-item:nth-child(${e+1})`);if(s&&s.seat_uids&&s.seat_uids.length>0&&s.event_seating_id)try{console.log("[CartPage] Releasing seats for removed item:",s.seat_uids),await AmbiletAPI.delete("/cart/seats",{event_seating_id:s.event_seating_id,seat_uids:s.seat_uids}),console.log("[CartPage] Seats released successfully")}catch(e){console.error("[CartPage] Failed to release seats:",e)}n&&(n.style.opacity="0",n.style.transform="translateX(-20px)",n.style.transition="all 0.3s ease",setTimeout(()=>{t.splice(e,1),AmbiletCart.save(t),this.render(),0===t.length&&(localStorage.removeItem("cart_end_time"),this.timerInterval&&clearInterval(this.timerInterval))},300))},updateSummary(){const e=AmbiletCart.getItems();let t=0,s=0,n=0,i=0;const o=[];let a=!1;const r={};e.forEach(e=>{const l=e.eventId||e.event?.id||"unknown",d=e.event?.title||e.event?.name||"Eveniment",c=e.event?.date||e.event_date||"",m=e.event?.venue?.name||("string"==typeof e.event?.venue?e.event.venue:"")||e.venue_name||"",u=e.event?.city?.name||e.event?.city||e.event?.venue?.city||"";r[l]||(r[l]={title:d,date:c,venue:m,city:u,tickets:[],subtotal:0,commission:0});const p=e.ticketType?.price||e.price||0,g=e.ticketType?.originalPrice||e.original_price||0,v=e.ticketType?.name||e.ticket_type_name||"Bilet",h=e.quantity||1,x=AmbiletCart.calculateItemCommission(e);let f=0;"added_on_top"===x.mode&&(f=x.amount,a=!0);const b=p*h,y=f*h;if(t+=b,s+=y,n+=h,r[l].subtotal+=b,r[l].commission+=y,r[l].tickets.push({name:v,qty:h,basePrice:p,lineTotal:b,commission:x,commissionTotal:y,hasDiscount:g&&g>p,originalPrice:g}),g&&g>p){i+=(g-p)*h,o.push(v)}});const l=t+s;let d=l-this.discount;const c=Math.floor(d/10);document.getElementById("totalItems").textContent=n,document.getElementById("summaryItems").textContent=n,document.getElementById("subtotal").textContent=AmbiletUtils.formatCurrency(l);const m=document.getElementById("taxesContainer");if(m){let e="";const t=Object.keys(r),n=t.length>1;t.forEach(function(t,s){const i=r[t];if(n){s>0&&(e+='<div class="pt-3 mt-3 border-t border-border"></div>');var o=i.title,a=[];i.date&&a.push(AmbiletUtils.formatDate(i.date,"short")),i.venue&&a.push(i.venue),i.city&&i.city!==i.venue&&a.push(i.city),a.length>0&&(o+=' <span class="font-normal text-muted">('+a.join(", ")+")</span>"),e+='<div class="mb-2 text-sm font-bold text-secondary">'+o+"</div>"}i.tickets.forEach(function(t){e+='<div class="flex justify-between text-sm"><span class="text-muted">'+t.qty+"x "+t.name+'</span><span class="font-medium">'+AmbiletUtils.formatCurrency(t.lineTotal)+"</span></div>"})}),a&&s>0&&(e+='<div class="flex justify-between pt-3 mt-3 text-sm border-t border-border"><span class="text-muted">Taxe procesare</span><span class="font-medium">'+AmbiletUtils.formatCurrency(s)+"</span></div>"),m.innerHTML=e}if(document.getElementById("totalPrice").textContent=AmbiletUtils.formatCurrency(d),this.discount>0?(document.getElementById("discountRow").classList.remove("hidden"),document.getElementById("discountAmount").textContent=`-${AmbiletUtils.formatCurrency(this.discount)}`):document.getElementById("discountRow").classList.add("hidden"),i>0){document.getElementById("savingsRow").classList.remove("hidden"),document.getElementById("savings").textContent=AmbiletUtils.formatCurrency(i);const e=document.getElementById("savingsText");if(e&&o.length>0){const t=[...new Set(o)].join(", ");e.textContent=`Alegând ${t} ai economisit:`}}else document.getElementById("savingsRow").classList.add("hidden");const u=document.getElementById("pointsEarned");u.textContent=c,u.classList.remove("points-animation"),u.offsetWidth,u.classList.add("points-animation")},formatSeats(e){if(!e||0===e.length)return"";const t={};e.forEach(e=>{const s=(e.section||"Secțiune")+" - Rând "+(e.row||"?");t[s]||(t[s]=[]),t[s].push(e.seat||e.label||"?")});const s=[];return Object.keys(t).forEach(e=>{const n=t[e].join(", ");s.push(e+": Loc "+n)}),s.join(" | ")},async applyPromo(){const e=document.getElementById("promoCode").value.trim().toUpperCase(),t=document.getElementById("promoMessage");if(!e)return t.textContent="Te rugăm să introduci un cod promoțional",t.className="mt-2 text-sm text-muted",void t.classList.remove("hidden");const s=document.querySelector("#promo-section button");s&&(s.disabled=!0,s.textContent="Se verifică...");const n=await AmbiletCart.applyPromoCode(e);if(n.success){const i=n.promo;this.discount=AmbiletCart.getPromoDiscount(),this.appliedPromo=e;const o="percentage"===i.type?`-${i.value}% reducere`:`-${AmbiletUtils.formatCurrency(i.value)} reducere`;t.innerHTML=`✓ Cod aplicat! ${o}`,t.className="mt-2 text-sm text-success",t.classList.remove("hidden"),document.getElementById("promoCode").disabled=!0,s&&(s.textContent="Aplicat",s.disabled=!0),this.updateSummary()}else t.textContent="✗ "+(n.message||"Cod invalid sau expirat"),t.className="mt-2 text-sm text-primary",t.classList.remove("hidden"),s&&(s.disabled=!1,s.textContent="Aplică")},loadExistingPromo(){const e=AmbiletCart.getPromoCode();if(!e)return;this.discount=AmbiletCart.getPromoDiscount(),this.appliedPromo=e.code;const t=document.getElementById("promoMessage");if(t){const s="percentage"===e.type?`-${e.value}% reducere`:`-${AmbiletUtils.formatCurrency(e.value)} reducere`;t.innerHTML=`✓ Cod aplicat: ${e.code} (${s})`,t.className="mt-2 text-sm text-success",t.classList.remove("hidden")}const s=document.getElementById("promoCode");s&&(s.value=e.code,s.disabled=!0);const n=document.querySelector("#promo-section button");n&&(n.textContent="Aplicat",n.disabled=!0)}};document.addEventListener("DOMContentLoaded",()=>CartPage.init()),window.addEventListener("ambilet:cart:expired",()=>{console.log("[CartPage] Cart expired event received"),CartPage.timerInterval&&clearInterval(CartPage.timerInterval),localStorage.removeItem("cart_end_time"),CartPage.render()}),document.addEventListener("DOMContentLoaded",()=>FeaturedCarousel.init());
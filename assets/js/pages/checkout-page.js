const CheckoutPage={items:[],taxes:[],insurance:null,insuranceSelected:!1,culturalCardSurchargeRate:4,totals:{subtotal:0,tax:0,discount:0,insurance:0,culturalCardSurcharge:0,total:0,savings:0},timerInterval:null,endTime:null,async init(){if(this.items=AmbiletCart.getItems(),this.loadTaxes(),0===this.items.length)return document.getElementById("checkout-loading").classList.add("hidden"),void document.getElementById("empty-cart").classList.remove("hidden");await this.loadCheckoutFeatures(),this.setupTimer(),this.setupPaymentOptions(),this.setupTermsCheckbox(),this.setupInsuranceCheckbox(),this.prefillBuyerInfo(),this.renderBeneficiaries(),this.renderSummary(),document.getElementById("checkout-loading").classList.add("hidden"),document.getElementById("checkout-form").classList.remove("hidden"),document.getElementById("summary-section").classList.remove("hidden")},async loadCheckoutFeatures(){try{const e=await AmbiletAPI.get("/checkout.features");if(e.success&&e.data&&e.data.ticket_insurance&&e.data.ticket_insurance.enabled&&e.data.ticket_insurance.show_in_checkout){this.insurance=e.data.ticket_insurance;let t,n;"refundable_only"===(this.insurance.apply_to||"all")?(t=this.items.filter(e=>e.ticketType?.is_refundable),n=this.items.filter(e=>!e.ticketType?.is_refundable)):(t=[...this.items],n=[]);const i=t.length>0,a=i&&n.length>0;if(!i)return void(this.insurance=null);this.insurance._refundableItems=t,this.insurance._isMixed=a,this.setupInsuranceUI()}}catch(e){console.log("Could not load checkout features:",e)}},setupInsuranceUI(){if(!this.insurance)return;const e=document.getElementById("insurance-section");if(!e)return;e.classList.remove("hidden"),document.getElementById("insurance-label").textContent=this.insurance.label||"Taxa de retur",document.getElementById("insurance-title").textContent=this.insurance.label||"Protecție returnare bilete",document.getElementById("insurance-description").textContent=this.insurance.description||"";const t=this.insurance._isMixed,n=this.insurance._refundableItems||[],i=n.reduce((e,t)=>e+(t.quantity||1),0);this.calculateInsuranceAmount();if("fixed"===this.insurance.price_type){const e=this.insurance.price||0;document.getElementById("insurance-price").textContent=AmbiletUtils.formatCurrency(e)+"/bilet"}else document.getElementById("insurance-price").textContent=this.insurance.price_percentage+"% din total";const a=document.getElementById("insurance-partial-note");if(a&&t){const e=n.map(e=>e.ticketType?.name||"Bilet").join(", ");a.textContent="Se aplică doar pentru biletele returnabile: "+e,a.classList.remove("hidden")}if(this.insurance.terms_url){const e=document.getElementById("insurance-terms-link");e.href=this.insurance.terms_url,e.classList.remove("hidden")}const s=document.getElementById("insuranceCheckbox");this.insurance.pre_checked&&(s.checked=!0,this.insuranceSelected=!0),document.getElementById("insurance-row-label").textContent=(this.insurance.label||"Taxa de retur")+" ("+i+" bilete)"},setupInsuranceCheckbox(){const e=document.getElementById("insuranceCheckbox");if(e&&(e.addEventListener("change",()=>{this.insuranceSelected=e.checked;const t=document.getElementById("insurance-option");t&&(this.insuranceSelected?(t.classList.add("border-success","bg-success/5"),t.classList.remove("border-border")):(t.classList.remove("border-success","bg-success/5"),t.classList.add("border-border"))),this.renderSummary()}),this.insuranceSelected)){const e=document.getElementById("insurance-option");e&&(e.classList.add("border-success","bg-success/5"),e.classList.remove("border-border"))}},calculateInsuranceAmount(){if(!this.insurance)return 0;const e=this.insurance._refundableItems||[];if(0===e.length)return 0;const t=e.reduce((e,t)=>e+(t.quantity||1),0);if("percentage"===this.insurance.price_type){const t=e.reduce((e,t)=>e+(t.ticketType?.price||t.price||0)*(t.quantity||1),0);return Math.round(t*(this.insurance.price_percentage/100)*100)/100}const n=this.insurance.price||0;return Math.round(n*t*100)/100},setupTimer(){const e=localStorage.getItem("cart_end_time"),t=document.getElementById("timer-bar");e&&parseInt(e)>Date.now()?(this.endTime=parseInt(e),t.classList.remove("hidden"),this.updateCountdown(),this.timerInterval=setInterval(()=>this.updateCountdown(),1e3)):this.items.length>0&&(this.endTime=Date.now()+9e5,localStorage.setItem("cart_end_time",this.endTime),t.classList.remove("hidden"),this.updateCountdown(),this.timerInterval=setInterval(()=>this.updateCountdown(),1e3))},updateCountdown(){const e=Math.max(0,this.endTime-Date.now()),t=Math.floor(e/6e4),n=Math.floor(e%6e4/1e3),i=document.getElementById("countdown");i&&(i.textContent=`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`,e<=0?(clearInterval(this.timerInterval),i.textContent="00:00",i.classList.remove("text-warning"),i.classList.add("text-primary"),AmbiletCart.clear(),localStorage.removeItem("cart_end_time"),"undefined"!=typeof AmbiletNotifications&&AmbiletNotifications.warning("Timpul de rezervare a expirat. Biletele au fost eliberate."),setTimeout(()=>{window.location.href="/cos"},2e3)):e<6e4&&(i.classList.remove("text-warning"),i.classList.add("text-primary")))},setupPaymentOptions(){document.querySelectorAll(".payment-option").forEach(e=>{e.addEventListener("click",function(){document.querySelectorAll(".payment-option").forEach(e=>e.classList.remove("selected")),this.classList.add("selected"),this.querySelector('input[type="radio"]').checked=!0;const e=this.querySelector("input").value,t=document.getElementById("cardForm"),n=document.getElementById("culturalCardForm");t.style.display="card"===e?"block":"none",n.style.display="card_cultural"===e?"block":"none",CheckoutPage.renderSummary()})})},setupTermsCheckbox(){document.getElementById("termsCheckbox").addEventListener("change",function(){document.getElementById("payBtn").disabled=!this.checked})},loadTaxes(){this.items.length>0&&this.items[0].event?.taxes?.length>0?this.taxes=this.items[0].event.taxes.filter(e=>!1!==e.is_active):this.taxes=[]},prefillBuyerInfo(){const e="undefined"!=typeof AmbiletAuth?AmbiletAuth.getUser():null,t=document.getElementById("guest-login-btn"),n=document.getElementById("create-account-row");e?(document.getElementById("buyer-first-name").value=e.first_name||"",document.getElementById("buyer-last-name").value=e.last_name||e.name||"",document.getElementById("buyer-email").value=e.email||"",document.getElementById("buyer-email-confirm").value=e.email||"",document.getElementById("buyer-phone").value=e.phone||"",t&&t.classList.add("hidden"),t?.classList.remove("flex"),n&&n.classList.add("hidden")):(t&&(t.classList.remove("hidden"),t.classList.add("flex")),n&&n.classList.remove("hidden"));document.getElementById("buyer-email-confirm").addEventListener("blur",()=>this.validateEmailMatch()),document.getElementById("buyer-email").addEventListener("blur",()=>this.validateEmailMatch())},showLoginModal(){const e=document.getElementById("login-modal");e&&(e.classList.remove("hidden"),e.classList.add("flex"),document.getElementById("login-email").focus())},hideLoginModal(){const e=document.getElementById("login-modal");e&&(e.classList.add("hidden"),e.classList.remove("flex"))},async handleLogin(e){e.preventDefault();const t=document.getElementById("login-email").value,n=document.getElementById("login-password").value,i=document.getElementById("login-submit-btn"),a=document.getElementById("login-btn-text");i.disabled=!0,a.innerHTML='<svg class="inline w-5 h-5 mr-2 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Se conectează...';try{const e=await AmbiletAuth.login(t,n,!0);if(e.success){AmbiletNotifications.success("Conectare reușită!"),this.hideLoginModal();const e=AmbiletAuth.getUser();e&&(document.getElementById("buyer-first-name").value=e.first_name||"",document.getElementById("buyer-last-name").value=e.last_name||e.name||"",document.getElementById("buyer-email").value=e.email||"",document.getElementById("buyer-email-confirm").value=e.email||"",document.getElementById("buyer-phone").value=e.phone||"");const t=document.getElementById("guest-login-btn");t&&(t.classList.add("hidden"),t.classList.remove("flex"));const n=document.getElementById("create-account-row");n&&n.classList.add("hidden")}else AmbiletNotifications.error(e.message||"Email sau parola incorectă")}catch(e){AmbiletNotifications.error("Eroare la conectare. Încearcă din nou.")}finally{i.disabled=!1,a.textContent="Conectează-te"}return!1},validateEmailMatch(){const e=document.getElementById("buyer-email").value.trim(),t=document.getElementById("buyer-email-confirm").value.trim(),n=document.getElementById("email-mismatch-error"),i=document.getElementById("buyer-email-confirm");return t&&e!==t?(n.classList.remove("hidden"),i.classList.add("border-primary"),!1):(n.classList.add("hidden"),i.classList.remove("border-primary"),!0)},renderBeneficiaries(){const e=document.getElementById("beneficiariesList");let t="",n=0;this.items.forEach((e,i)=>{const a=e.quantity||1;for(let s=0;s<a;s++){n++;const a=e.ticketType?.price||e.price||0,c=e.ticketType?.originalPrice||e.original_price||0,r=e.ticketType?.name||e.ticket_type_name||"Bilet",o=e.event?.title||e.event_title||"Eveniment";c&&c>a&&Math.round(100*(1-a/c));t+=`\n                    <div class="p-4 border-2 beneficiary-card border-border rounded-xl">\n                        <div class="flex items-center justify-between mb-4">\n                            <div class="flex items-center gap-3">\n                                <div class="flex items-center justify-center w-10 h-10 font-bold text-white rounded-lg date-badge">${n}</div>\n                                <div>\n                                    <p class="font-semibold text-secondary">${r}</p>\n                                    <p class="text-xs text-muted">${o}</p>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="grid gap-4 md:grid-cols-2">\n                            <div>\n                                <label class="block mb-2 text-sm font-medium text-secondary">Nume beneficiar *</label>\n                                <input type="text" placeholder="Nume complet" class="w-full px-4 py-3 border-2 beneficiary-input beneficiary-name input-field border-border rounded-xl focus:outline-none" data-item="${i}" data-index="${s}">\n                            </div>\n                            <div>\n                                <label class="block mb-2 text-sm font-medium text-secondary">Email beneficiar *</label>\n                                <input type="email" placeholder="email@exemplu.com" class="w-full px-4 py-3 border-2 beneficiary-input beneficiary-email input-field border-border rounded-xl focus:outline-none" data-item="${i}" data-index="${s}">\n                            </div>\n                        </div>\n                    </div>\n                `}}),e.innerHTML=t,document.getElementById("beneficiaries-count").textContent=`${n} bilete`},toggleBeneficiaries(){const e=document.getElementById("differentBeneficiaries"),t=document.getElementById("beneficiariesList"),n=document.getElementById("allTicketsToEmail");e.checked?(t.classList.remove("hidden"),n.classList.add("hidden")):(t.classList.add("hidden"),n.classList.remove("hidden"))},renderSummary(){const e={};let t=0,n=0,i=0,a=0,s=!1;this.items.forEach(c=>{const r=c.eventId||c.event?.id||"unknown",o=c.event?.title||c.event?.name||c.event_title||"Eveniment",l=c.event?.image||c.event_image||"/assets/images/default-event.png",d=c.event?.date||c.event_date||"",m=c.event?.venue?.name||("string"==typeof c.event?.venue?c.event.venue:"")||c.venue_name||"",u=c.event?.city?.name||c.event?.city||c.event?.venue?.city||"";e[r]||(e[r]={title:o,image:l,date:d,venue:m,city:u,tickets:[],subtotal:0,commission:0});const h=c.ticketType?.price||c.price||0,y=c.ticketType?.originalPrice||c.original_price||0,p=c.ticketType?.name||c.ticket_type_name||"Bilet",g=c.quantity||1,b=AmbiletCart.calculateItemCommission(c);let f=0;"added_on_top"===b.mode&&(f=b.amount,s=!0);const v=h*g,I=f*g;t+=v,n+=I,a+=g,e[r].subtotal+=v,e[r].commission+=I;const E=y&&y>h;E&&(i+=(y-h)*g),e[r].tickets.push({name:p,qty:g,price:h,lineTotal:v,hasDiscount:E,originalPrice:y})});const c=Object.keys(e),r=c.length>1,o=document.getElementById("event-info");if(r)o.style.display="none";else{o.style.display="";const t=e[c[0]];o.innerHTML=`\n                <img src="${t.image}" alt="Event" class="object-cover w-20 h-20 rounded-xl" loading="lazy">\n                <div>\n                    <h3 class="font-bold text-secondary">${t.title}</h3>\n                    <p class="text-sm text-muted">${t.date?AmbiletUtils.formatDate(t.date):""}</p>\n                    <p class="text-sm text-muted">${t.venue}</p>\n                </div>\n            `}const l=document.getElementById("items-summary");let d="";c.forEach((t,n)=>{const i=e[t];if(r){n>0&&(d+='<div class="pt-3 mt-3 border-t border-border"></div>');let e=[];i.date&&e.push(AmbiletUtils.formatDate(i.date,"short")),i.venue&&e.push(i.venue);const t=i.city||"";t&&t!==i.venue&&e.push(t);const a=e.length>0?` <span class="font-normal text-muted">(${e.join(", ")})</span>`:"";d+=`<div class="mb-2 text-sm font-bold text-secondary">${i.title}${a}</div>`}i.tickets.forEach(e=>{d+=`\n                    <div class="flex justify-between text-sm">\n                        <span class="text-muted">${e.qty}x ${e.name}</span>\n                        <div class="text-right">\n                            ${e.hasDiscount?`<span class="mr-2 text-xs line-through text-muted">${AmbiletUtils.formatCurrency(e.originalPrice*e.qty)}</span>`:""}\n                            <span class="font-medium">${AmbiletUtils.formatCurrency(e.lineTotal)}</span>\n                        </div>\n                    </div>\n                `})}),l.innerHTML=d;let m=0;this.insuranceSelected&&this.insurance&&(m=this.calculateInsuranceAmount());const u=AmbiletCart.getPromoDiscount(),h=t+n,y=Math.max(0,h+m-u);let p=0;"card_cultural"===(document.querySelector('input[name="payment"]:checked')?.value||"card")&&(p=Math.round(y*(this.culturalCardSurchargeRate/100)*100)/100);const g=y+p,b=Math.floor(g/10);this.totals={subtotal:h,tax:0,discount:u,insurance:m,culturalCardSurcharge:p,total:g,savings:i},document.getElementById("summary-items").textContent=a,document.getElementById("summary-subtotal").textContent=AmbiletUtils.formatCurrency(h);const f=document.getElementById("taxes-container");f&&(f.innerHTML=s&&n>0?'<div class="flex justify-between text-sm"><span class="text-muted">Taxe procesare</span><span class="font-medium">'+AmbiletUtils.formatCurrency(n)+"</span></div>":"");const v=document.getElementById("insurance-row");v&&(this.insuranceSelected&&m>0?(v.classList.remove("hidden"),document.getElementById("insurance-row-amount").textContent="+"+AmbiletUtils.formatCurrency(m)):v.classList.add("hidden"));const I=document.getElementById("cultural-card-row");I&&(p>0?(I.classList.remove("hidden"),document.getElementById("cultural-card-amount").textContent="+"+AmbiletUtils.formatCurrency(p)):I.classList.add("hidden"));const E=document.getElementById("discount-row");if(E)if(u>0){const e=AmbiletCart.getPromoCode();E.classList.remove("hidden"),document.getElementById("discount-label").textContent="Reducere"+(e?" ("+e.code+")":""),document.getElementById("discount-amount").textContent="-"+AmbiletUtils.formatCurrency(u)}else E.classList.add("hidden");document.getElementById("summary-total").textContent=AmbiletUtils.formatCurrency(g),document.getElementById("pay-btn-text").textContent=`Plătește ${AmbiletUtils.formatCurrency(g)}`,document.getElementById("points-earned").textContent=`${b} puncte`,i>0&&(document.getElementById("savings-text").classList.remove("hidden"),document.getElementById("savings-amount").textContent=`Economisești ${AmbiletUtils.formatCurrency(i)}!`)},validateForm(){const e=document.getElementById("buyer-first-name").value.trim(),t=document.getElementById("buyer-last-name").value.trim(),n=document.getElementById("buyer-email").value.trim(),i=document.getElementById("buyer-email-confirm").value.trim(),a=document.getElementById("buyer-phone").value.trim();return e&&t&&n&&i&&a?n!==i?("undefined"!=typeof AmbiletNotifications&&AmbiletNotifications.error("Adresele de email nu coincid"),document.getElementById("buyer-email-confirm").focus(),!1):!!document.getElementById("termsCheckbox").checked||("undefined"!=typeof AmbiletNotifications&&AmbiletNotifications.error("Trebuie să accepți termenii și condițiile"),!1):("undefined"!=typeof AmbiletNotifications&&AmbiletNotifications.error("Completează toate câmpurile obligatorii"),!1)},getBeneficiaries(){const e=[],t=document.getElementById("differentBeneficiaries").checked,n=document.getElementById("buyer-first-name").value.trim(),i=`${document.getElementById("buyer-last-name").value.trim()} ${n}`.trim(),a=document.getElementById("buyer-email").value.trim();return this.items.forEach((n,s)=>{const c=n.quantity||1;for(let n=0;n<c;n++){if(t){const t=document.querySelector(`.beneficiary-name[data-item="${s}"][data-index="${n}"]`),c=document.querySelector(`.beneficiary-email[data-item="${s}"][data-index="${n}"]`);e.push({name:t?.value.trim()||i,email:c?.value.trim()||a,item_index:s,ticket_index:n})}else e.push({name:i,email:a,item_index:s,ticket_index:n});0}}),e},async submit(){if(!this.validateForm())return;const e=document.getElementById("payBtn"),t=document.getElementById("pay-btn-text");e.disabled=!0,t.innerHTML='\n            <svg class="inline w-5 h-5 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">\n                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>\n                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>\n            </svg>\n            Se procesează...\n        ';const n={first_name:document.getElementById("buyer-first-name").value.trim(),last_name:document.getElementById("buyer-last-name").value.trim(),email:document.getElementById("buyer-email").value.trim(),phone:document.getElementById("buyer-phone").value.trim()},i=document.getElementById("createAccountCheckbox");if(i&&i.checked){const e="ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789!@#$";let t="";for(let n=0;n<12;n++)t+=e.charAt(Math.floor(Math.random()*e.length));n.password=t}const a=this.getBeneficiaries(),s=document.querySelector('input[name="payment"]:checked')?.value||"card",c=document.getElementById("newsletterCheckbox").checked,r=document.getElementById("termsCheckbox").checked;try{const e={customer:n,beneficiaries:a,items:this.items,payment_method:s,newsletter:c,accept_terms:r},i=AmbiletCart.getPromoCode();i&&i.code&&(e.promo_code=i.code),this.insuranceSelected&&this.totals.insurance>0&&(e.ticket_insurance=!0,e.ticket_insurance_amount=this.totals.insurance),"card_cultural"===s&&this.totals.culturalCardSurcharge>0&&(e.cultural_card_surcharge=this.totals.culturalCardSurcharge);const o=await AmbiletAPI.post("/checkout",e);if(!o.success)throw new Error(o.message||"Eroare la procesarea comenzii");const l=o.data.orders?.[0];if(!l)throw new Error("Nu s-a putut crea comanda");if(o.data.payment_required&&l.total>0){t.innerHTML='\n                    <svg class="inline w-5 h-5 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">\n                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>\n                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>\n                    </svg>\n                    Se redirecționează către plată...\n                ';const e=await AmbiletAPI.post(`/orders/${l.id}/pay`,{return_url:window.location.origin+"/multumim?order="+l.order_number,cancel_url:window.location.origin+"/checkout"});if(!e.success||!e.data.payment_url)throw new Error(e.message||"Nu s-a putut iniția plata");if(AmbiletCart.clear(),localStorage.removeItem("cart_end_time"),"POST"===e.data.method&&e.data.form_data){const t=document.createElement("form");t.method="POST",t.action=e.data.payment_url;for(const[n,i]of Object.entries(e.data.form_data)){const e=document.createElement("input");e.type="hidden",e.name=n,e.value=i,t.appendChild(e)}document.body.appendChild(t),t.submit()}else window.location.href=e.data.payment_url}else AmbiletCart.clear(),localStorage.removeItem("cart_end_time"),window.location.href="/multumim?order="+l.order_number}catch(n){console.error("Checkout error:",n),"undefined"!=typeof AmbiletNotifications&&AmbiletNotifications.error(n.message||"Eroare la procesare. Încearcă din nou."),e.disabled=!1,t.textContent=`Plătește ${AmbiletUtils.formatCurrency(this.totals.total)}`}}};document.addEventListener("DOMContentLoaded",()=>CheckoutPage.init());
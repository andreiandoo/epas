function toggleOrder(e){e.closest(".order-card").classList.toggle("expanded")}const UserOrders={orders:[],async init(){AmbiletAuth.isAuthenticated()?(this.loadUserInfo(),await this.loadOrders(),document.getElementById("filter-status").addEventListener("change",()=>this.filterOrders())):window.location.href="/autentificare?redirect=/cont/comenzi"},loadUserInfo(){const e=AmbiletAuth.getUser();if(e){const t=e.name?.split(" ").map(e=>e[0]).join("").substring(0,2).toUpperCase()||"U",s=document.getElementById("header-user-avatar");s&&(s.innerHTML=`<span class="text-sm font-bold text-white">${t}</span>`);const n=document.getElementById("header-user-points");n&&(n.textContent=(e.points||0).toLocaleString())}},async loadOrders(){try{const e=await AmbiletAPI.customer.getOrders();e.success&&e.data?this.orders=e.data.orders||e.data||[]:(console.warn("No orders in API response"),this.orders=[])}catch(e){console.error("Failed to load orders:",e),this.orders=[]}this.updateStats(),this.renderOrders()},updateStats(){const e=this.orders.filter(e=>["confirmed","paid","completed"].includes(e.status)),t=e.reduce((e,t)=>e+(parseFloat(t.total)||0),0),s=e.reduce((e,t)=>e+(parseFloat(t.savings)||0),0);document.getElementById("stat-total").textContent=this.orders.length,document.getElementById("stat-spent").textContent=t.toLocaleString("ro-RO",{minimumFractionDigits:0,maximumFractionDigits:2})+" lei",document.getElementById("stat-saved").textContent=s.toLocaleString("ro-RO",{minimumFractionDigits:0,maximumFractionDigits:2})+" lei"},filterOrders(){this.renderOrders()},renderOrders(){const e=document.getElementById("orders-list"),t=document.getElementById("filter-status").value;let s=this.orders;t&&(s=this.orders.filter(e=>e.status===t)),0!==s.length?(e.innerHTML=s.map(e=>this.renderOrderCard(e)).join(""),document.getElementById("load-more").classList.remove("hidden")):e.innerHTML=`\n                <div class="py-12 text-center bg-white border rounded-xl border-border">\n                    <p class="mb-4 text-muted">Nu ai comenzi ${t?"in aceasta categorie":"inca"}</p>\n                    <a href="/" class="btn btn-primary inline-flex px-6 py-2.5 text-white font-semibold rounded-xl">Descopera evenimente</a>\n                </div>\n            `},renderOrderCard(e){const t={confirmed:"bg-success/10 text-success",completed:"bg-muted/20 text-muted",pending:"bg-warning/10 text-warning",paid:"bg-success/10 text-success",refunded:"bg-error/10 text-error"}[e.status]||"bg-muted/20 text-muted",s={confirmed:"CONFIRMAT",completed:"ÎNCHEIAT",pending:"ÎN AȘTEPTARE",paid:"PLĂTIT",refunded:"RAMBURSAT"}[e.status]||(e.status||"UNKNOWN").toUpperCase(),n="completed"===e.status||"refunded"===e.status,a=e.event?.image||e.event?.featured_image||e.tickets?.[0]?.event?.image||"/assets/images/default-event.png",r=e.event?.title||e.event_name||e.tickets?.[0]?.event?.title||"Eveniment",i=e.reference||e.order_number||"#"+String(e.id).padStart(6,"0"),o=e.items||e.order_items||[],d=e.tickets_count||o.reduce((e,t)=>e+(t.quantity||1),0)||e.tickets?.length||0,l=o[0]?.name||e.tickets?.[0]?.ticketType?.name||"Bilet";return`\n            <div class="overflow-hidden bg-white border order-card rounded-xl border-border">\n                <button onclick="toggleOrder(this)" class="w-full p-4 text-left lg:p-5">\n                    <div class="flex items-center gap-4">\n                        <div class="w-14 h-14 rounded-lg overflow-hidden flex-shrink-0 ${n?"grayscale opacity-75":""}">\n                            <img src="${a}" class="object-cover w-full h-full" alt="" onerror="this.src='/assets/images/default-event.png'" loading="lazy">\n                        </div>\n                        <div class="mobile:flex-col mobile:flex">\n                            <div class="flex-1 min-w-0">\n                                <div class="flex flex-wrap items-center gap-2">\n                                    <span class="font-mono text-xs text-muted">${i}</span>\n                                </div>\n                                <h3 class="font-semibold text-secondary">${r}</h3>\n                                <p class="text-sm text-muted">${this.formatDateTime(e.created_at)} • ${d<2?"1 bilet":d+" bilete"} ${l}</p>\n                            </div>\n                            <div class="mobile:items-center mobile:gap-4 mobile:flex">\n                                <div class="flex items-center flex-shrink-0 text-right gap-x-4">\n                                    ${"refunded"===e.status?`<p class="font-bold line-through text-muted">${e.total} lei</p><p class="text-xs text-error">Rambursat</p>`:`<span class="flex items-center justify-center px-2 py-0.5 ${t} text-xs font-bold rounded">${s}</span> <p class="font-bold text-secondary">${e.total} lei</p>${e.points_earned?`<p class="text-xs text-success">+${e.points_earned} puncte</p>`:""}`}\n                                </div>\n                                <svg class="w-5 h-5 expand-icon text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>\n                            </div>\n                        </div>\n                    </div>\n                </button>\n\n                <div class="border-t order-details border-border">\n                    <div class="p-4 lg:p-5 bg-surface/50">\n                        ${"refunded"===e.status?this.renderRefundDetails(e):this.renderOrderDetails(e)}\n                    </div>\n                </div>\n            </div>\n        `},renderOrderDetails(e){return`\n            ${"confirmed"===e.status?'\n            <div class="mb-6">\n                <h4 class="mb-3 text-sm font-semibold text-secondary">Status comandă</h4>\n                <div class="flex items-center justify-between">\n                    <div class="flex items-center flex-1">\n                        <div class="flex items-center justify-center w-8 h-8 rounded-full bg-success">\n                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>\n                        </div>\n                        <div class="w-full h-1 bg-success"></div>\n                    </div>\n                    <div class="flex items-center flex-1">\n                        <div class="flex items-center justify-center w-8 h-8 rounded-full bg-success">\n                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>\n                        </div>\n                        <div class="w-full h-1 bg-success"></div>\n                    </div>\n                    <div class="flex items-center">\n                        <div class="flex items-center justify-center w-8 h-8 rounded-full bg-success">\n                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>\n                        </div>\n                    </div>\n                </div>\n                <div class="flex justify-between mt-2 text-xs text-muted">\n                    <span>Comanda plasată</span>\n                    <span>Plata confirmată</span>\n                    <span>Bilete emise</span>\n                </div>\n            </div>\n            ':""}\n\n            ${e.checked_in?'\n            <div class="mb-4">\n                <div class="flex items-center gap-2 p-3 rounded-lg bg-success/10">\n                    <svg class="w-5 h-5 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>\n                    <span class="text-sm font-medium text-success">Check-in efectuat</span>\n                </div>\n            </div>\n            ':""}\n\n            <div class="grid gap-4 mb-4 sm:grid-cols-2">\n                <div>\n                    <h4 class="mb-2 text-sm font-semibold text-secondary">Detalii bilete</h4>\n                    <div class="space-y-2">\n                        ${e.items.map(e=>`\n                        <div class="flex justify-between text-sm">\n                            <span class="text-muted">${e.quantity}x ${e.name}</span>\n                            <span class="text-secondary">${(e.quantity*e.price).toFixed(2)} lei</span>\n                        </div>\n                        `).join("")}\n                        ${e.commission_amount>0&&["on_top","add_on_top","added_on_top"].includes(e.commission_mode)?`\n                        <div class="flex justify-between text-sm">\n                            <span class="text-muted">Comision servicii ${e.commission_rate?`(${e.commission_rate}%)`:""}</span>\n                            <span class="text-secondary">${parseFloat(e.commission_amount).toFixed(2)} lei</span>\n                        </div>\n                        `:""}\n                        ${e.discount?`\n                        <div class="flex justify-between text-sm">\n                            <span class="text-muted">Cod promoțional ${e.promo_code?`(${e.promo_code})`:""}</span>\n                            <span class="text-success">-${parseFloat(e.discount).toFixed(2)} lei</span>\n                        </div>\n                        `:""}\n                        <hr class="border-border">\n                        <div class="flex justify-between font-semibold">\n                            <span class="text-secondary">Total plătit</span>\n                            <span class="text-secondary">${(["on_top","add_on_top","added_on_top"].includes(e.commission_mode)?parseFloat(e.total)+parseFloat(e.commission_amount||0):parseFloat(e.total)).toFixed(2)} lei</span>\n                        </div>\n                        ${e.commission_amount>0&&"included"===e.commission_mode?`\n                        <div class="flex justify-between text-xs text-muted">\n                            <span>din care comision inclus</span>\n                            <span>${parseFloat(e.commission_amount).toFixed(2)} lei</span>\n                        </div>\n                        `:""}\n                    </div>\n                </div>\n                <div>\n                    <h4 class="mb-2 text-sm font-semibold text-secondary">Informații plată</h4>\n                    <div class="space-y-2 text-sm">\n                        ${e.payment_method?`\n                        <div class="flex justify-between">\n                            <span class="text-muted">Metoda</span>\n                            <span class="text-secondary">${e.payment_method}</span>\n                        </div>\n                        `:'\n                        <div class="flex justify-between">\n                            <span class="text-muted">Metoda</span>\n                            <span class="text-secondary">-</span>\n                        </div>\n                        '}\n                        <div class="flex justify-between">\n                            <span class="text-muted">Status</span>\n                            <span class="${"paid"===e.payment_status||"paid"===e.status||"confirmed"===e.status?"text-success":"text-warning"}">${"paid"===e.payment_status||"paid"===e.status||"confirmed"===e.status?"Plătit":"pending"===e.payment_status?"În așteptare":e.payment_status||e.status}</span>\n                        </div>\n                        ${e.paid_at?`\n                        <div class="flex justify-between">\n                            <span class="text-muted">Data plății</span>\n                            <span class="text-secondary">${this.formatDateTime(e.paid_at)}</span>\n                        </div>\n                        `:""}\n                    </div>\n                </div>\n            </div>\n\n            <div class="flex flex-wrap gap-2 pt-4 border-t border-border">\n                ${"confirmed"===e.status||"paid"===e.status?'\n                <a href="/cont/bilete" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white transition-colors rounded-lg bg-primary hover:bg-primary-dark">\n                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"/></svg>\n                    Vezi biletele\n                </a>\n                ':""}\n                ${e.can_request_refund?`\n                <button onclick="UserOrders.requestRefund(${e.id}, '${e.refund_reason||""}')" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-red-600 transition-colors border border-red-300 rounded-lg hover:bg-red-50 hover:border-red-400">\n                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>\n                    Returneaza comanda\n                </button>\n                `:""}\n                <button class="flex items-center gap-2 px-4 py-2 text-sm font-medium transition-colors rounded-lg bg-surface text-secondary hover:bg-primary/10 hover:text-primary">\n                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>\n                    Descarcă factura\n                </button>\n                <button class="flex items-center gap-2 px-4 py-2 text-sm font-medium transition-colors rounded-lg text-muted hover:bg-surface">\n                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>\n                    Ajutor\n                </button>\n            </div>\n        `},renderRefundDetails:e=>`\n            <div class="p-4 mb-4 border bg-error/5 border-error/20 rounded-xl">\n                <div class="flex items-start gap-3">\n                    <div class="flex items-center justify-center flex-shrink-0 w-10 h-10 rounded-lg bg-error/10">\n                        <svg class="w-5 h-5 text-error" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>\n                    </div>\n                    <div>\n                        <p class="font-semibold text-error">${e.refund_reason||"Comandă rambursată"}</p>\n                        <p class="mt-1 text-sm text-muted">Rambursarea a fost procesată automat în contul tău pe ${e.refund_date}.</p>\n                    </div>\n                </div>\n            </div>\n            <div class="grid gap-4 sm:grid-cols-2">\n                <div>\n                    <h4 class="mb-2 text-sm font-semibold text-secondary">Detalii rambursare</h4>\n                    <div class="space-y-2 text-sm">\n                        <div class="flex justify-between">\n                            <span class="text-muted">Suma rambursată</span>\n                            <span class="font-medium text-success">${e.refunded_amount} lei</span>\n                        </div>\n                        <div class="flex justify-between">\n                            <span class="text-muted">Data rambursării</span>\n                            <span class="text-secondary">${e.refund_date}</span>\n                        </div>\n                        ${e.points_earned?`\n                        <div class="flex justify-between">\n                            <span class="text-muted">Puncte returnate</span>\n                            <span class="text-secondary">-${e.points_earned} puncte</span>\n                        </div>\n                        `:""}\n                    </div>\n                </div>\n            </div>\n        `,formatDateTime(e){const t=new Date(e),s=t.getDate(),n=t.getHours().toString().padStart(2,"0"),a=t.getMinutes().toString().padStart(2,"0");return`${s} ${["Ian","Feb","Mar","Apr","Mai","Iun","Iul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()]} ${t.getFullYear()}, ${n}:${a}`},logout(){AmbiletAuth.logout(),window.location.href="/login"},requestRefund(e,t){console.log("Requesting refund for order:",e,"reason:",t),window.location.href="/cont/cerere-rambursare?order="+e+"&reason="+encodeURIComponent(t||"")}};document.addEventListener("DOMContentLoaded",()=>UserOrders.init());
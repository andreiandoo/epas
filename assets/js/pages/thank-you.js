const ThankYouPage={order:null,async init(){this.createConfetti(),await this.loadOrderData()},createConfetti(){const e=document.getElementById("confetti"),t=["#A51C30","#10B981","#E67E22","#3B82F6","#8B5CF6","#EC4899"];for(let n=0;n<80;n++)setTimeout(()=>{const n=document.createElement("div");n.className="confetti",n.style.left=100*Math.random()+"%",n.style.backgroundColor=t[Math.floor(Math.random()*t.length)],n.style.animationDelay=2*Math.random()+"s",n.style.animationDuration=2*Math.random()+3+"s",Math.random()>.5&&(n.style.borderRadius="0",n.style.transform=`rotate(${360*Math.random()}deg)`),e.appendChild(n),setTimeout(()=>n.remove(),6e3)},50*n)},async loadOrderData(){const e=new URLSearchParams(window.location.search),t=e.get("order")||e.get("orderId");if(t){if(e.get("orderId")||e.has("orderId")){const e=window.location.pathname+"?order="+encodeURIComponent(t);history.replaceState(null,"",e)}try{const e=await AmbiletAPI.get(`/order-confirmation/${t}`);e.success&&e.data?.order?(this.order=e.data.order,this.renderOrderData()):(console.warn("Order data not found in response:",e),this.showDemoData())}catch(e){console.error("Failed to load order:",e),this.showDemoData()}}else this.showDemoData()},showDemoData(){document.getElementById("printingText").textContent="Biletele sunt gata!",document.getElementById("ticketsCount").textContent="Verifică email-ul pentru bilete",document.getElementById("buyerEmail").textContent="Email-ul tău"},renderOrderData(){const e=this.order;document.getElementById("printingText").textContent="Biletele sunt gata!",document.getElementById("buyerEmail").textContent=e.customer_email||"Email-ul tău";const t=document.getElementById("eventInfo"),n=e.event;if(n){const e=n.name||n.title||"Eveniment",i=n.date?AmbiletUtils.formatDate(n.date):"",o=n.doors_open||(n.date?new Date(n.date).toLocaleTimeString("ro-RO",{hour:"2-digit",minute:"2-digit"}):""),a="object"==typeof n.venue&&null!==n.venue?n.venue.ro||n.venue.en||Object.values(n.venue)[0]||"":n.venue||"";t.innerHTML=`\n                <img src="${getStorageUrl(n.image)}" alt="${e}" class="object-cover w-20 h-20 rounded-xl" loading="lazy" onerror="this.style.display='none'">\n                <div>\n                    <h3 class="font-bold text-secondary">${e}</h3>\n                    <p class="mt-1 text-sm text-muted">${i}${o?" • "+o:""}</p>\n                    <p class="text-sm text-muted">${a}${n.city?", "+n.city:""}</p>\n                </div>\n            `}const i=e.tickets||[];this.renderTickets(Array.isArray(i)?i:Object.values(i));const o=document.getElementById("ticketsSummary"),a=(e.tickets||[]).filter(e=>e.seat);if(e.items&&e.items.length>0){let t='<h4 class="mb-3 font-semibold text-secondary">Bilete achiziționate</h4>';t+=e.items.map(e=>`\n                <div class="flex items-center justify-between py-2 border-b border-border last:border-0">\n                    <div>\n                        <span class="font-medium text-secondary">${e.name}</span>\n                        <span class="ml-1 text-sm text-muted">× ${e.quantity}</span>\n                    </div>\n                    <span class="font-semibold">${AmbiletUtils.formatCurrency(e.total)}</span>\n                </div>\n            `).join("");const n=(e.tickets||[]).filter(e=>e.has_insurance);n.length>0&&(t+=`<div class="pt-3 mt-3 border-t border-border">\n                    <div class="flex items-center gap-2 text-sm text-green-700">\n                        <svg class="flex-shrink-0 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>\n                        <span class="font-medium">${n.length} bilet${n.length>1?"e":""} asigurat${n.length>1?"e":""} cu taxa de retur</span>\n                    </div>\n                </div>`),a.length>0&&(t+=`<div class="pt-3 mt-3 border-t border-border">\n                    <p class="mb-2 text-xs font-medium tracking-wide uppercase text-muted">Locuri atribuite</p>\n                    ${a.map(e=>`\n                        <div class="flex items-center gap-2 py-1 text-sm">\n                            <span class="text-muted">${e.type||"Bilet"}</span>\n                            <span class="font-medium text-secondary">\n                                ${[e.seat.section_name,e.seat.row_label?"Rând "+e.seat.row_label:"",e.seat.seat_number?"Loc "+e.seat.seat_number:""].filter(Boolean).join(", ")}\n                            </span>\n                        </div>\n                    `).join("")}\n                </div>`),o.innerHTML=t}const s=parseFloat(e.subtotal)||0,d=parseFloat(e.total)||0,r=parseFloat(e.discount)||0,l=parseFloat(e.service_fee)||0,c=parseFloat(e.insurance_amount)||0;e.currency;if(document.getElementById("paymentSummary").innerHTML=`\n            <h4 class="mb-3 font-semibold text-secondary">Sumar plată</h4>\n            <div class="space-y-2 text-sm">\n                <div class="flex justify-between">\n                    <span class="text-muted">Subtotal</span>\n                    <span>${AmbiletUtils.formatCurrency(s)}</span>\n                </div>\n                ${l>0?`\n                <div class="flex justify-between">\n                    <span class="text-muted">Comision serviciu</span>\n                    <span>${AmbiletUtils.formatCurrency(l)}</span>\n                </div>\n                `:""}\n                ${c>0?`\n                <div class="flex justify-between">\n                    <span class="text-muted">Taxa de retur</span>\n                    <span>${AmbiletUtils.formatCurrency(c)}</span>\n                </div>\n                `:""}\n                ${r>0?`\n                <div class="flex justify-between text-success">\n                    <span>Reducere</span>\n                    <span>-${AmbiletUtils.formatCurrency(r)}</span>\n                </div>\n                `:""}\n                <div class="flex justify-between pt-2 text-lg font-bold border-t border-border">\n                    <span>Total plătit</span>\n                    <span class="text-primary">${AmbiletUtils.formatCurrency(d)}</span>\n                </div>\n            </div>\n        `,e.payment_method){const t=document.getElementById("cardNumber");t&&(t.textContent=e.payment_method)}const m=document.getElementById("pointsEarned");m&&(m.style.display="none");const p=document.getElementById("downloadBtn");p&&e.can_download_tickets&&(p.href="#",p.addEventListener("click",e=>{e.preventDefault(),this.downloadTickets()}));const u=document.getElementById("calendarBtn");u&&e.event&&(u.href="#",u.addEventListener("click",e=>{e.preventDefault(),this.addToCalendar()}));const v=window.location.origin+"/bilete/"+(e.event?.slug||"event"),f=e.event?.name||e.event?.title||"Eveniment",x=document.getElementById("shareFb");x&&(x.href="https://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent(v),x.target="_blank");const y=document.getElementById("shareWa");y&&(y.href="https://wa.me/?text="+encodeURIComponent(f+" - "+v),y.target="_blank")},downloadTickets(){const e=this.order;if(!e||!e.tickets)return;const t=e.event,n=t?.name||t?.title||"Eveniment",i=t?.date?AmbiletUtils.formatDate(t.date):"",o="object"==typeof t?.venue?t.venue?.ro||t.venue?.en||"":t?.venue||"",a=window.AMBILET?.siteName||"bilete.online",s=e.tickets.map((s,d)=>{const r=s.seat?[s.seat.section_name,s.seat.row_label?"Rând "+s.seat.row_label:"",s.seat.seat_number?"Loc "+s.seat.seat_number:""].filter(Boolean).join(" | "):"";return`\n                <div style="page-break-inside: avoid; border: 2px solid #1E293B; border-radius: 12px; padding: 24px; margin-bottom: 24px; max-width: 500px;">\n                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px dashed #E2E8F0;">\n                        <div>\n                            <div style="font-size: 11px; color: #64748B; text-transform: uppercase;">${a}</div>\n                            <div style="font-size: 18px; font-weight: 700;">${s.type||"Bilet"}</div>\n                        </div>\n                        <div style="text-align: right; font-size: 12px; color: #64748B;">${d+1} / ${e.tickets.length}</div>\n                    </div>\n                    <div style="margin-bottom: 12px;">\n                        <div style="font-size: 11px; color: #64748B;">EVENIMENT</div>\n                        <div style="font-size: 16px; font-weight: 600;">${n}</div>\n                    </div>\n                    <div style="display: flex; gap: 24px; margin-bottom: 12px;">\n                        <div><div style="font-size: 11px; color: #64748B;">DATA</div><div style="font-weight: 600;">${i}</div></div>\n                        <div><div style="font-size: 11px; color: #64748B;">LOCAȚIE</div><div style="font-weight: 600;">${o}${t?.city?", "+t.city:""}</div></div>\n                    </div>\n                    ${r?`<div style="margin-bottom: 12px; padding: 8px 12px; background: #F1F5F9; border-radius: 8px; font-weight: 600;">${r}</div>`:""}\n                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">\n                        <div><div style="font-size: 11px; color: #64748B;">PARTICIPANT</div><div style="font-weight: 500;">${s.attendee_name||e.customer_name||""}</div></div>\n                        <div style="text-align: right;"><div style="font-size: 11px; color: #64748B;">PREȚ</div><div style="font-weight: 700; color: #A51C30;">${AmbiletUtils.formatCurrency(s.price)}</div></div>\n                    </div>\n                    <div style="text-align: center; padding-top: 12px; border-top: 1px solid #E2E8F0;">\n                        ${s.code||s.barcode?`<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(s.code||s.barcode)}" style="width: 150px; height: 150px;" onerror="this.style.display='none';this.nextElementSibling.style.display='block'" />\n                        <div style="display:none;padding:10px;border:2px solid #1E293B;border-radius:8px;font-family:monospace;font-size:14px;font-weight:bold;word-break:break-all">${s.code||s.barcode}</div>`:'<div style="padding:10px;color:#94A3B8;font-size:12px;">Cod indisponibil</div>'}\n                        <div style="font-family: monospace; font-size: 11px; color: #64748B; margin-top: 6px;">${s.code||s.barcode||""}</div>\n                    </div>\n                </div>\n            `}).join(""),d=window.open("","_blank");d.document.write(`<!DOCTYPE html><html><head><title>Bilete - ${e.order_number}</title>\n            <style>body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 20px; color: #1E293B; }\n            @media print { body { padding: 0; } }</style></head>\n            <body><div style="max-width: 500px; margin: 0 auto;">${s}</div>\n            <script>\n            // Wait for QR code images to load before printing\n            function waitForImages() {\n                var imgs = document.querySelectorAll('img');\n                var loaded = 0;\n                var total = imgs.length;\n                if (total === 0) { window.print(); return; }\n                imgs.forEach(function(img) {\n                    if (img.complete) { loaded++; if (loaded >= total) window.print(); }\n                    else {\n                        img.onload = function() { loaded++; if (loaded >= total) window.print(); };\n                        img.onerror = function() { loaded++; if (loaded >= total) window.print(); };\n                    }\n                });\n                // Fallback: print after 3 seconds even if images haven't loaded\n                setTimeout(function() { window.print(); }, 3000);\n            }\n            waitForImages();\n            <\/script></body></html>`),d.document.close()},addToCalendar(){const e=this.order?.event;if(!e)return;const t=e.name||e.title||"Eveniment",n=("object"==typeof e.venue?e.venue?.ro||e.venue?.en||"":e.venue||"")+(e.city?", "+e.city:""),i=e.date?new Date(e.date):null;if(!i)return void("undefined"!=typeof AmbiletNotifications&&AmbiletNotifications.info("Data evenimentului nu este disponibilă."));const o=e=>e.toISOString().replace(/[-:]/g,"").replace(/\.\d{3}/,""),a=new Date(i.getTime()+108e5),s="https://www.google.com/calendar/render?action=TEMPLATE&text="+encodeURIComponent(t)+"&dates="+o(i)+"/"+o(a)+"&location="+encodeURIComponent(n)+"&details="+encodeURIComponent("Bilete achiziționate pe "+(window.AMBILET?.siteName||"bilete.online"));window.open(s,"_blank")},renderTickets(e){const t=document.getElementById("ticketsScroll"),n=document.getElementById("scrollIndicators"),i=e.length;if(0===i)return void(document.getElementById("ticketsCount").textContent="Nu există bilete");document.getElementById("ticketsCount").textContent=`${i} bilet${i>1?"e":""} pentru ${this.order?.event?.name||this.order?.event?.title||"eveniment"}`,t.innerHTML=e.map((e,t)=>this.renderTicketCard(e,t,i)).join(""),n.innerHTML=e.map((e,t)=>`<div class="scroll-dot ${0===t?"active":""}" data-index="${t}"></div>`).join(""),t.addEventListener("scroll",()=>{const e=t.querySelector(".ticket-card")?.offsetWidth+16||296,i=Math.round(t.scrollLeft/e);n.querySelectorAll(".scroll-dot").forEach((e,t)=>{e.classList.toggle("active",t===i)})}),n.querySelectorAll(".scroll-dot").forEach(e=>{e.addEventListener("click",function(){const e=parseInt(this.dataset.index),n=t.querySelector(".ticket-card")?.offsetWidth+16||296;t.scrollTo({left:e*n,behavior:"smooth"})})});let o=!1,a=0,s=0;t.addEventListener("mousedown",e=>{o=!0,a=e.pageX,s=t.scrollLeft,t.classList.add("dragging")}),document.addEventListener("mousemove",e=>{o&&(e.preventDefault(),t.scrollLeft=s-(e.pageX-a))}),document.addEventListener("mouseup",()=>{o&&(o=!1,t.classList.remove("dragging"))}),t.setAttribute("tabindex","0"),t.addEventListener("keydown",e=>{const n=t.querySelector(".ticket-card")?.offsetWidth+16||296;"ArrowRight"===e.key&&(e.preventDefault(),t.scrollBy({left:n,behavior:"smooth"})),"ArrowLeft"===e.key&&(e.preventDefault(),t.scrollBy({left:-n,behavior:"smooth"}))})},renderTicketCard(e,t,n){const i=Array(15).fill(0).map(()=>`<div class="barcode-line" style="height: ${20+15*Math.random()}px;"></div>`).join(""),o=this.order?.event,a=o?.name||o?.title||"Eveniment",s=o?.date?AmbiletUtils.formatDate(o.date,"medium"):"",d=o?.doors_open||(o?.date?new Date(o.date).toLocaleTimeString("ro-RO",{hour:"2-digit",minute:"2-digit"}):""),r=o?.venue?"object"==typeof o.venue?o.venue.ro||o.venue.en||Object.values(o.venue)[0]||"":o.venue:"";return`\n            <div class="ticket-card" data-index="${t}">\n                <div class="ticket-card-header">\n                    <div class="flex items-center justify-between mb-2">\n                        <span class="text-xs opacity-70">${window.AMBILET?.siteName||"Ambilet"} TICKET</span>\n                        <span class="text-xs font-bold bg-white/20 px-2 py-0.5 rounded">${t+1} / ${n}</span>\n                    </div>\n                    <h3 class="text-lg font-bold">${e.type||e.type_name||"Bilet"}</h3>\n                </div>\n                <div class="ticket-card-body">\n                    <div class="ticket-dashed-line"></div>\n\n                    <div class="mt-4 space-y-3">\n                        <div>\n                            <p class="text-xs tracking-wide uppercase text-muted">Eveniment</p>\n                            <p class="font-bold text-secondary">${a}</p>\n                        </div>\n                        <div class="flex gap-4">\n                            <div>\n                                <p class="text-xs tracking-wide uppercase text-muted">Data</p>\n                                <p class="font-semibold text-secondary">${s}</p>\n                            </div>\n                            ${d?`\n                            <div>\n                                <p class="text-xs tracking-wide uppercase text-muted">Ora</p>\n                                <p class="font-semibold text-secondary">${d}</p>\n                            </div>\n                            `:""}\n                        </div>\n                        <div>\n                            <p class="text-xs tracking-wide uppercase text-muted">Locație</p>\n                            <p class="font-semibold text-secondary">${r}${o?.city?", "+o.city:""}</p>\n                        </div>\n                        ${e.seat?`\n                        <div class="flex flex-wrap gap-4">\n                            ${e.seat.section_name?`\n                            <div>\n                                <p class="text-xs tracking-wide uppercase text-muted">Secțiune</p>\n                                <p class="font-semibold text-secondary">${e.seat.section_name}</p>\n                            </div>`:""}\n                            ${e.seat.row_label?`\n                            <div>\n                                <p class="text-xs tracking-wide uppercase text-muted">Rând</p>\n                                <p class="font-semibold text-secondary">${e.seat.row_label}</p>\n                            </div>`:""}\n                            ${e.seat.seat_number?`\n                            <div>\n                                <p class="text-xs tracking-wide uppercase text-muted">Loc</p>\n                                <p class="font-semibold text-secondary">${e.seat.seat_number}</p>\n                            </div>`:""}\n                        </div>\n                        `:""}\n                        <div class="flex items-center justify-between pt-2">\n                            <div>\n                                <p class="text-xs text-muted">Participant</p>\n                                <p class="text-sm font-semibold text-secondary">${e.attendee_name||this.order?.billing_address||"Participant"}</p>\n                            </div>\n                            <div class="text-right">\n                                <p class="text-xs text-muted">Preț</p>\n                                <p class="font-bold text-primary">${AmbiletUtils.formatCurrency(e.price)}</p>\n                            </div>\n                        </div>\n                        ${e.has_insurance?'\n                        <div class="inline-flex items-center gap-1 px-2 py-1 mt-2 text-xs font-medium text-green-700 rounded-full bg-green-50">\n                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>\n                            Asigurat - Taxa de retur\n                        </div>\n                        ':""}\n                    </div>\n\n                    <div class="ticket-barcode">${i}</div>\n                    <p class="text-center text-[10px] text-muted mt-2">${e.code||e.barcode||""}</p>\n                </div>\n            </div>\n        `},copyLink(){const e=window.location.origin+"/bilete/"+(this.order?.event?.slug||"event");navigator.clipboard.writeText(e).then(()=>{"undefined"!=typeof AmbiletNotifications?AmbiletNotifications.success("Link copiat în clipboard!"):alert("Link copiat în clipboard!")})}};document.addEventListener("DOMContentLoaded",()=>ThankYouPage.init());
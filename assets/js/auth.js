const AmbiletAuth={KEYS:{CUSTOMER_TOKEN:"ambilet_customer_token",CUSTOMER_DATA:"ambilet_customer_data",ORGANIZER_TOKEN:"ambilet_organizer_token",ORGANIZER_DATA:"ambilet_organizer_data",USER_TYPE:"ambilet_user_type",REDIRECT_AFTER_LOGIN:"ambilet_redirect_after_login",REFERRAL_CODE:"ambilet_referral_code",REFERRAL_INFO:"ambilet_referral_info"},getToken(){return"organizer"===this.getUserType()?localStorage.getItem(this.KEYS.ORGANIZER_TOKEN):localStorage.getItem(this.KEYS.CUSTOMER_TOKEN)},getUserType(){return localStorage.getItem(this.KEYS.USER_TYPE)||null},isLoggedIn(){return!!this.getToken()},isCustomer(){return"customer"===this.getUserType()&&this.isLoggedIn()},isOrganizer(){return"organizer"===this.getUserType()&&this.isLoggedIn()},async loginCustomer(e,t){try{const r=await AmbiletAPI.customer.login(e,t);return r.success&&r.data.token?(this.setCustomerSession(r.data.token,r.data.customer),{success:!0,customer:r.data.customer}):{success:!1,message:r.message||"Login failed"}}catch(e){return{success:!1,message:e.message,errors:e.errors}}},async registerCustomer(e){try{const t=this.getReferralCode();t&&!e.referral_code&&(e.referral_code=t);const r=await AmbiletAPI.customer.register(e);return r.success?(r.data.token&&this.setCustomerSession(r.data.token,r.data.customer),this.clearReferralCode(),r.data.referral&&r.data.referral.message&&setTimeout(()=>{"undefined"!=typeof AmbiletNotifications&&AmbiletNotifications.success(r.data.referral.message,6e3)},500),{success:!0,customer:r.data.customer,requiresVerification:!r.data.token,referral:r.data.referral}):{success:!1,message:r.message||"Registration failed"}}catch(e){return{success:!1,message:e.message,errors:e.errors}}},setCustomerSession(e,t){localStorage.setItem(this.KEYS.CUSTOMER_TOKEN,e),localStorage.setItem(this.KEYS.CUSTOMER_DATA,JSON.stringify(t)),localStorage.setItem(this.KEYS.USER_TYPE,"customer"),localStorage.removeItem(this.KEYS.ORGANIZER_TOKEN),localStorage.removeItem(this.KEYS.ORGANIZER_DATA),window.dispatchEvent(new CustomEvent("ambilet:auth:login",{detail:{type:"customer",user:t}}))},getCustomerData(){const e=localStorage.getItem(this.KEYS.CUSTOMER_DATA);return e?JSON.parse(e):null},updateCustomerData(e){const t={...this.getCustomerData()||{},...e};localStorage.setItem(this.KEYS.CUSTOMER_DATA,JSON.stringify(t)),window.dispatchEvent(new CustomEvent("ambilet:auth:update",{detail:{type:"customer",user:t}}))},async logoutCustomer(){try{await AmbiletAPI.customer.logout()}catch(e){}this.clearCustomerSession()},clearCustomerSession(){localStorage.removeItem(this.KEYS.CUSTOMER_TOKEN),localStorage.removeItem(this.KEYS.CUSTOMER_DATA),"customer"===this.getUserType()&&localStorage.removeItem(this.KEYS.USER_TYPE),window.dispatchEvent(new CustomEvent("ambilet:auth:logout",{detail:{type:"customer"}}))},async loginOrganizer(e,t){try{const r=await AmbiletAPI.organizer.login(e,t);return r.success&&r.data.token?(this.setOrganizerSession(r.data.token,r.data.organizer),{success:!0,organizer:r.data.organizer}):{success:!1,message:r.message||"Login failed"}}catch(e){return{success:!1,message:e.message,errors:e.errors}}},async registerOrganizer(e){try{const t=await AmbiletAPI.organizer.register(e);return t.success?(t.data.token&&this.setOrganizerSession(t.data.token,t.data.organizer),{success:!0,organizer:t.data.organizer,requiresVerification:!t.data.token}):{success:!1,message:t.message||"Registration failed"}}catch(e){return{success:!1,message:e.message,errors:e.errors}}},setOrganizerSession(e,t){localStorage.setItem(this.KEYS.ORGANIZER_TOKEN,e),localStorage.setItem(this.KEYS.ORGANIZER_DATA,JSON.stringify(t)),localStorage.setItem(this.KEYS.USER_TYPE,"organizer"),localStorage.removeItem(this.KEYS.CUSTOMER_TOKEN),localStorage.removeItem(this.KEYS.CUSTOMER_DATA),window.dispatchEvent(new CustomEvent("ambilet:auth:login",{detail:{type:"organizer",user:t}}))},getOrganizerData(){const e=localStorage.getItem(this.KEYS.ORGANIZER_DATA);return e?JSON.parse(e):null},updateOrganizerData(e){const t={...this.getOrganizerData()||{},...e};localStorage.setItem(this.KEYS.ORGANIZER_DATA,JSON.stringify(t)),window.dispatchEvent(new CustomEvent("ambilet:auth:update",{detail:{type:"organizer",user:t}}))},async logoutOrganizer(){try{await AmbiletAPI.organizer.logout()}catch(e){}this.clearOrganizerSession()},clearOrganizerSession(){localStorage.removeItem(this.KEYS.ORGANIZER_TOKEN),localStorage.removeItem(this.KEYS.ORGANIZER_DATA),"organizer"===this.getUserType()&&localStorage.removeItem(this.KEYS.USER_TYPE),window.dispatchEvent(new CustomEvent("ambilet:auth:logout",{detail:{type:"organizer"}}))},async login(e,t){return this.loginCustomer(e,t)},async register(e){return this.registerCustomer(e)},isAuthenticated(){return this.isLoggedIn()},getUser(){return this.getCurrentUser()},getCurrentUser(){const e=this.getUserType();return"customer"===e?this.getCustomerData():"organizer"===e?this.getOrganizerData():null},logout(){const e=this.getUserType();return"customer"===e?this.logoutCustomer():"organizer"===e?this.logoutOrganizer():(this.clearCustomerSession(),void this.clearOrganizerSession())},setRedirectAfterLogin(e){sessionStorage.setItem(this.KEYS.REDIRECT_AFTER_LOGIN,e)},getRedirectAfterLogin(){const e=sessionStorage.getItem(this.KEYS.REDIRECT_AFTER_LOGIN);return sessionStorage.removeItem(this.KEYS.REDIRECT_AFTER_LOGIN),e},requireCustomerAuth(e=null){if(!this.isCustomer()){const t=e||window.location.href;return this.setRedirectAfterLogin(t),window.location.href="/login",!1}return!0},requireOrganizerAuth(e=null){if(!this.isOrganizer()){const t=e||window.location.href;return this.setRedirectAfterLogin(t),window.location.href="/organizator/login",!1}return!0},async refreshCurrentUser(){try{const e=this.getUserType();if("customer"===e){const e=await AmbiletAPI.customer.getProfile();if(e.success)return this.updateCustomerData(e.data),e.data}else if("organizer"===e){const e=await AmbiletAPI.organizer.getProfile();if(e.success)return this.updateOrganizerData(e.data),e.data}}catch(e){throw e.isAuthError&&e.isAuthError()&&this.logout(),e}return null},getReferralCode(){return localStorage.getItem(this.KEYS.REFERRAL_CODE)},setReferralCode(e){localStorage.setItem(this.KEYS.REFERRAL_CODE,e)},getReferralInfo(){const e=localStorage.getItem(this.KEYS.REFERRAL_INFO);return e?JSON.parse(e):null},setReferralInfo(e){localStorage.setItem(this.KEYS.REFERRAL_INFO,JSON.stringify(e))},clearReferralCode(){localStorage.removeItem(this.KEYS.REFERRAL_CODE),localStorage.removeItem(this.KEYS.REFERRAL_INFO)},async checkReferralCode(){const e=new URLSearchParams(window.location.search).get("ref");if(!e)return;if(this.isLoggedIn())return;if(this.getReferralCode()!==e)try{const t=await AmbiletAPI.customer.validateReferralCode(e);if(t.success&&t.data.valid){this.setReferralCode(e),this.setReferralInfo(t.data),this.showReferralBanner(t.data);const r=new URL(window.location);r.searchParams.delete("ref"),window.history.replaceState({},"",r)}}catch(e){console.error("Error validating referral code:",e)}else this.showReferralBanner()},showReferralBanner(e=null){const t=e||this.getReferralInfo();if(!t)return;if(this.isLoggedIn())return;let r=document.getElementById("referral-banner");r||(r=document.createElement("div"),r.id="referral-banner",r.className="fixed top-0 left-0 right-0 z-50 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 px-4 text-center shadow-lg",r.innerHTML=`\n            <div class="container mx-auto flex items-center justify-center gap-3 flex-wrap">\n                <span class="text-lg">ðŸŽ‰</span>\n                <span class="font-medium">${t.message||"Ai fost invitat! Primesti "+t.referred_reward+" puncte bonus la inregistrare."}</span>\n                <a href="/register" class="bg-white text-purple-600 px-4 py-1 rounded-full font-semibold hover:bg-gray-100 transition-colors text-sm">\n                    Inregistreaza-te acum\n                </a>\n                <button onclick="this.closest('#referral-banner').remove()" aria-label="ÃŽnchide" class="ml-2 text-white/80 hover:text-white">\n                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>\n                    </svg>\n                </button>\n            </div>\n        `,document.body.style.paddingTop="56px",document.body.insertBefore(r,document.body.firstChild))},init(){this.isLoggedIn()||(this.checkReferralCode(),this.getReferralCode()&&this.showReferralBanner()),window.dispatchEvent(new CustomEvent("ambilet:auth:init",{detail:{isLoggedIn:this.isLoggedIn(),userType:this.getUserType(),user:this.getCurrentUser()}}))}};document.addEventListener("DOMContentLoaded",()=>{AmbiletAuth.init()});
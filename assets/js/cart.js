const AmbiletCart={STORAGE_KEY:"ambilet_cart",PROMO_KEY:"ambilet_cart_promo",RESERVATION_KEY:"ambilet_cart_reservation",getCart(){const t=localStorage.getItem(this.STORAGE_KEY);return t?JSON.parse(t):{items:[],updatedAt:null}},saveCart(t){t.updatedAt=(new Date).toISOString(),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t)),window.dispatchEvent(new CustomEvent("ambilet:cart:update",{detail:{cart:t,itemCount:this.getItemCount()}}))},addItem(t,e,i,a,s=1){const n=this.getCart(),r=`${t}_${i}`,o=n.items.findIndex(t=>t.key===r);return o>=0?n.items[o].quantity+=s:n.items.push({key:r,eventId:t,event:{id:e.id,title:e.title,slug:e.slug,date:e.start_date,time:e.start_time,image:e.image||e.featured_image,venue:e.venue,city:e.venue?.city,taxes:e.taxes||[],target_price:e.target_price||null,commission_rate:e.commission_rate||5,commission_mode:e.commission_mode||"included"},ticketTypeId:i,ticketType:{id:a.id,name:a.name,price:a.price,originalPrice:a.original_price,description:a.description,min_per_order:a.min_per_order||1,max_per_order:a.max_per_order||10,commission:a.commission||null,is_refundable:a.is_refundable||!1},quantity:s,addedAt:(new Date).toISOString()}),this.saveCart(n),this.startReservationTimer(),this.showNotification(`${a.name} adăugat în coș!`),n},updateQuantity(t,e){const i=this.getCart(),a=i.items.findIndex(e=>e.key===t);return a>=0&&(e<=0?i.items.splice(a,1):i.items[a].quantity=e,this.saveCart(i)),i},removeItem(t){const e=this.getCart(),i=e.items.findIndex(e=>e.key===t);if(i>=0){const t=e.items.splice(i,1)[0];this.saveCart(e),this.showNotification(`${t.ticketType.name} eliminat din coș`)}return e},clearCart(){const t={items:[],updatedAt:(new Date).toISOString()};return localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t)),localStorage.removeItem(this.PROMO_KEY),localStorage.removeItem(this.RESERVATION_KEY),localStorage.removeItem("cart_end_time"),window.dispatchEvent(new CustomEvent("ambilet:cart:clear")),window.dispatchEvent(new CustomEvent("ambilet:cart:update",{detail:{cart:t,itemCount:0}})),t},getItemCount(){return this.getCart().items.reduce((t,e)=>t+e.quantity,0)},getSubtotal(){return this.getCart().items.reduce((t,e)=>t+e.ticketType.price*e.quantity,0)},getSavings(){return this.getCart().items.reduce((t,e)=>e.ticketType.originalPrice&&e.ticketType.originalPrice>e.ticketType.price?t+(e.ticketType.originalPrice-e.ticketType.price)*e.quantity:t,0)},getSavingsWithTickets(){const t=this.getCart();let e=0;const i=[];return t.items.forEach(t=>{t.ticketType.originalPrice&&t.ticketType.originalPrice>t.ticketType.price&&(e+=(t.ticketType.originalPrice-t.ticketType.price)*t.quantity,i.push(t.ticketType.name))}),{amount:e,ticketNames:[...new Set(i)]}},getTaxes(){const t=this.getItems();return t.length>0&&t[0].event?.taxes?.length>0?t[0].event.taxes.filter(t=>!1!==t.is_active):[]},getTotalTaxes(){const t=this.getSubtotal(),e=this.getTaxes();let i=0;return e.forEach(e=>{e.is_active&&("percent"===e.value_type?i+=t*(e.value/100):"fixed"===e.value_type&&(i+=e.value*this.getItemCount()))}),i},getRedCrossTax(){return this.getTotalTaxes()},calculateItemCommission(t){const e=t.ticketType.price||0,i=t.ticketType.commission;if(i&&i.type){let t=0;switch(i.type){case"percentage":t=e*((i.rate||0)/100);break;case"fixed":t=i.fixed||0;break;case"both":t=e*((i.rate||0)/100)+(i.fixed||0)}return{amount:t,rate:i.rate||0,fixed:i.fixed||0,mode:i.mode||"included",type:i.type}}const a=t.event?.commission_rate||5;return{amount:e*(a/100),rate:a,fixed:0,mode:t.event?.commission_mode||"included",type:"percentage"}},getTotalCommission(){return this.getCart().items.reduce((t,e)=>t+this.calculateItemCommission(e).amount*e.quantity,0)},getCommissionBreakdown(){return this.getCart().items.map(t=>{const e=this.calculateItemCommission(t);return{ticketName:t.ticketType.name,eventTitle:t.event.title,basePrice:t.ticketType.price,commission:e,quantity:t.quantity,totalCommission:e.amount*t.quantity}})},getPointsEarned(){return Math.floor(this.getSubtotal()*AMBILET_CONFIG.POINTS_PER_CURRENCY)},getPromoCode(){const t=localStorage.getItem(this.PROMO_KEY);return t?JSON.parse(t):null},async applyPromoCode(t){const e=this.getCart();if(0===e.items.length)return{success:!1,message:"Coșul este gol"};try{const i=e.items[0].eventId,a=this.getSubtotal(),s=this.getItemCount(),n=await AmbiletAPI.validatePromoCode(t,i,a,s,AmbiletAuth.getCustomerData()?.email);if(n.success){const e={code:t,type:n.data.discount_type,value:n.data.discount_value,discountAmount:n.data.discount_amount,appliedAt:(new Date).toISOString()};return localStorage.setItem(this.PROMO_KEY,JSON.stringify(e)),window.dispatchEvent(new CustomEvent("ambilet:cart:promo",{detail:{promo:e}})),this.showNotification(`Cod promoțional "${t}" aplicat cu succes!`,"success"),{success:!0,promo:e}}return{success:!1,message:n.message||"Cod invalid"}}catch(t){return{success:!1,message:t.message}}},removePromoCode(){localStorage.removeItem(this.PROMO_KEY),window.dispatchEvent(new CustomEvent("ambilet:cart:promo",{detail:{promo:null}})),this.showNotification("Cod promoțional eliminat")},getPromoDiscount(){const t=this.getPromoCode();if(!t)return 0;const e=this.getSubtotal();return"percentage"===t.type?e*(t.value/100):Math.min(t.value,e)},getTotal(){const t=this.getSubtotal(),e=this.getRedCrossTax(),i=this.getPromoDiscount();return Math.max(0,t+e-i)},getSummary(){const t=this.getSavingsWithTickets();return{items:this.getCart().items,itemCount:this.getItemCount(),subtotal:this.getSubtotal(),savings:t.amount,savingsTicketNames:t.ticketNames,taxes:this.getTaxes(),totalTaxes:this.getTotalTaxes(),redCrossTax:this.getRedCrossTax(),promoCode:this.getPromoCode(),promoDiscount:this.getPromoDiscount(),total:this.getTotal(),pointsEarned:this.getPointsEarned(),totalCommission:this.getTotalCommission(),commissionBreakdown:this.getCommissionBreakdown()}},startReservationTimer(){const t=new Date(Date.now()+60*AMBILET_CONFIG.CART_RESERVATION_MINUTES*1e3);return localStorage.setItem(this.RESERVATION_KEY,t.toISOString()),localStorage.setItem("cart_end_time",t.getTime().toString()),window.dispatchEvent(new CustomEvent("ambilet:cart:reservation",{detail:{expiresAt:t.toISOString()}})),t},getReservationExpiry(){const t=localStorage.getItem(this.RESERVATION_KEY);return t?new Date(t):null},isReservationExpired(){const t=this.getReservationExpiry();return!t||new Date>=t},getRemainingTime(){const t=this.getReservationExpiry();if(!t)return 0;const e=Math.max(0,t.getTime()-Date.now());return Math.floor(e/1e3)},formatRemainingTime(){const t=this.getRemainingTime(),e=t%60;return`${Math.floor(t/60).toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`},clearReservation(){localStorage.removeItem(this.RESERVATION_KEY)},showNotification(t,e="info"){window.dispatchEvent(new CustomEvent("ambilet:notification",{detail:{message:t,type:e}}))},updateCartBadge(){const t=this.getItemCount();document.querySelectorAll("[data-cart-count]").forEach(e=>{e.textContent=t,e.style.display=t>0?"":"none"})},hasMultipleEvents(){const t=this.getCart();return new Set(t.items.map(t=>t.eventId)).size>1},getItemsByEvent(){const t=this.getCart(),e={};return t.items.forEach(t=>{e[t.eventId]||(e[t.eventId]={event:t.event,items:[]}),e[t.eventId].items.push(t)}),e},init(){this.updateCartBadge(),window.addEventListener("storage",t=>{t.key===this.STORAGE_KEY&&(this.updateCartBadge(),window.dispatchEvent(new CustomEvent("ambilet:cart:sync",{detail:{cart:this.getCart()}})))}),window.addEventListener("ambilet:cart:update",()=>{this.updateCartBadge()}),this.getItemCount()>0&&this.isReservationExpired()&&this.handleReservationExpired(),this.startExpiryCheck()},handleReservationExpired(){const t=this.getItemCount()>0;this.clearCart(),window.dispatchEvent(new CustomEvent("ambilet:cart:expired",{detail:{hadItems:t}})),t&&this.showNotification("Timpul de rezervare a expirat. Coșul a fost golit.","warning"),console.log("Cart reservation expired - cart cleared")},startExpiryCheck(){this._expiryCheckInterval&&clearInterval(this._expiryCheckInterval),this._expiryCheckInterval=setInterval(()=>{this.getItemCount()>0&&this.isReservationExpired()&&this.handleReservationExpired()},5e3)},stopExpiryCheck(){this._expiryCheckInterval&&(clearInterval(this._expiryCheckInterval),this._expiryCheckInterval=null)},getItems(){return this.getCart().items||[]},save(t){const e={items:t,updatedAt:(new Date).toISOString()};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e)),window.dispatchEvent(new CustomEvent("ambilet:cart:update",{detail:{cart:e,itemCount:t.reduce((t,e)=>t+(e.quantity||1),0)}}))},clear(){return this.clearCart()}};document.addEventListener("DOMContentLoaded",()=>{AmbiletCart.init()});